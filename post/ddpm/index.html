<!DOCTYPE html>
<!-- This site was created with Hugo Blox. https://hugoblox.com -->
<!-- Last Published: May 15, 2024 --><html lang="en-us" >


<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  
  
  
    <meta name="generator" content="Hugo Blox Builder 5.9.6" />
  

  
  












  
  










  







  
  
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  

  
  
  
    
      
      <link rel="preload" as="style" href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;700&family=Roboto+Mono&family=Roboto:wght@400;700&display=swap">
      <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;700&family=Roboto+Mono&family=Roboto:wght@400;700&display=swap" media="print" onload="this.media='all'">
    
  

  
  

  
  
    
    <script src="/js/mathjax-config.js"></script>
  

  

  <link rel="stylesheet" href="/css/vendor-bundle.min.047268c6dd09ad74ba54a0ba71837064.css" media="print" onload="this.media='all'">

  
  
  
    
    
      <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/jpswalsh/academicons@1.9.4/css/academicons.min.css" integrity="sha512-IW0nhlW5MgNydsXJO40En2EoCkTTjZhI3yuODrZIc8cQ4h1XcF53PsqDHa09NqnkXuIe0Oiyyj171BqZFwISBw==" crossorigin="anonymous" media="print" onload="this.media='all'">
    

    
    
    
    
      
      
    
    
    

    
    
    

    

    
    
      
      

      
      

      
    
      
      

      
      

      
    
      
      

      
      

      
    
      
      

      
      

      
    
      
      

      
      

      
    
      
      

      
      

      
    
      
      

      
      

      
    
      
      

      
      

      
    
      
      

      
      

      
    
      
      

      
      

      
    
      
      

      
      

      
        <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml.js" integrity="" crossorigin="anonymous" async></script>
      
    
      
      

      
      

      
    
      
      

      
      

      
    
  

  
  
  
  
  
  
  <link rel="stylesheet" href="/css/wowchemy.32e2e32cf1a4c1ea152e519f8b1fda79.css" />

  
  
  

  
  
  
  
  
  
  
    
    
    <link rel="stylesheet" href="/css/libs/chroma/github-light.min.css" title="hl-light" media="print" onload="this.media='all'" >
    <link rel="stylesheet" href="/css/libs/chroma/github-dark.min.css" title="hl-dark" media="print" onload="this.media='all'" disabled>
  

  
  



























  
  
  






  <meta name="author" content="Li Zhe" />





  

<meta name="description" content="主要针对扩散模型的一些经典文章写一些个人理解，博采众长，参考了很多博客、文章，详细信息见参考文献
Table of Contents 0、文生图片模型 1、几种生成模型的对比 2、扩散模型（DDPM） 3 、基于分数的生成模型（Score-based generative models） 参考文献 0、文生图片模型 DALL·E 3 扩散模型的大火始于2020年所提出的DDPM（&ldquo;Denoising Diffusion Probabilistic Models&rdquo;）。当前最先进的两个文本生成图像——OpenAI的DALL·E 3和Google的Imagen 2，都是基于扩散模型来完成的。
1、几种生成模型的对比 GAN（生成对抗网络）：GAN是由两部分组成，一个生成器和一个判别器。生成器的目标是创建足够真实的数据，以至于判别器不能区分生成的数据和真实数据。判别器的目标是正确区分真实数据和生成器生成的假数据。这两部分在训练过程中相互竞争，推动彼此的进步，因此称为对抗网络。GAN在图像生成方面尤其出色。
VAE（变分自编码器）：VAE采用不同的方法来生成数据。它通过编码器将数据映射到一个分布上，并从这个分布中采样来构造一个解码器用于数据重建。它是一种通过概率方法生成新数据的模型，通常用于生成遵循特定统计分布的图片。
Flow-based Models（基于流的模型）：这类模型使用可逆变换来学习数据的分布，这意味着它们可以精确地计算生成数据的概率。它们可以生成高质量的数据，并且给定新数据，也可以确定其概率。这种特性在密度估计和无损压缩方面特别有用。
Diffusion Models（扩散模型）：Diffusion Models 的灵感来自non-equilibrium thermodynamics （非平衡热力学）。理论首先定义扩散步骤的马尔可夫链，以缓慢地将随机噪声添加到数据中，然后学习逆向扩散过程以从噪声中构造所需的数据样本。与 VAE 或流模型不同，扩散模型是通过固定过程学习，并且隐空间具有比较高的维度。" />



<link rel="alternate" hreflang="en-us" href="https://ikerlz.github.io/post/ddpm/" />
<link rel="canonical" href="https://ikerlz.github.io/post/ddpm/" />



  <link rel="manifest" href="/manifest.webmanifest" />



<link rel="icon" type="image/png" href="/media/icon_hu9ccd2acdcd774e20fa34966445b706a8_6997380_32x32_fill_lanczos_center_3.png" />
<link rel="apple-touch-icon" type="image/png" href="/media/icon_hu9ccd2acdcd774e20fa34966445b706a8_6997380_180x180_fill_lanczos_center_3.png" />

<meta name="theme-color" content="#1565c0" />










  






<meta property="twitter:card" content="summary_large_image" />

  <meta property="twitter:site" content="@wowchemy" />
  <meta property="twitter:creator" content="@wowchemy" />
<meta property="twitter:image" content="https://ikerlz.github.io/post/ddpm/featured.png" />



  

<meta property="og:type" content="article" />
<meta property="og:site_name" content="Zhe Li" />
<meta property="og:url" content="https://ikerlz.github.io/post/ddpm/" />
<meta property="og:title" content="扩散模型（Diffusion Model） | Zhe Li" />
<meta property="og:description" content="主要针对扩散模型的一些经典文章写一些个人理解，博采众长，参考了很多博客、文章，详细信息见参考文献
Table of Contents 0、文生图片模型 1、几种生成模型的对比 2、扩散模型（DDPM） 3 、基于分数的生成模型（Score-based generative models） 参考文献 0、文生图片模型 DALL·E 3 扩散模型的大火始于2020年所提出的DDPM（&ldquo;Denoising Diffusion Probabilistic Models&rdquo;）。当前最先进的两个文本生成图像——OpenAI的DALL·E 3和Google的Imagen 2，都是基于扩散模型来完成的。
1、几种生成模型的对比 GAN（生成对抗网络）：GAN是由两部分组成，一个生成器和一个判别器。生成器的目标是创建足够真实的数据，以至于判别器不能区分生成的数据和真实数据。判别器的目标是正确区分真实数据和生成器生成的假数据。这两部分在训练过程中相互竞争，推动彼此的进步，因此称为对抗网络。GAN在图像生成方面尤其出色。
VAE（变分自编码器）：VAE采用不同的方法来生成数据。它通过编码器将数据映射到一个分布上，并从这个分布中采样来构造一个解码器用于数据重建。它是一种通过概率方法生成新数据的模型，通常用于生成遵循特定统计分布的图片。
Flow-based Models（基于流的模型）：这类模型使用可逆变换来学习数据的分布，这意味着它们可以精确地计算生成数据的概率。它们可以生成高质量的数据，并且给定新数据，也可以确定其概率。这种特性在密度估计和无损压缩方面特别有用。
Diffusion Models（扩散模型）：Diffusion Models 的灵感来自non-equilibrium thermodynamics （非平衡热力学）。理论首先定义扩散步骤的马尔可夫链，以缓慢地将随机噪声添加到数据中，然后学习逆向扩散过程以从噪声中构造所需的数据样本。与 VAE 或流模型不同，扩散模型是通过固定过程学习，并且隐空间具有比较高的维度。" /><meta property="og:image" content="https://ikerlz.github.io/post/ddpm/featured.png" /><meta property="og:locale" content="en-us" />

  
    <meta
      property="article:published_time"
      content="2024-04-05T00:39:27&#43;08:00"
    />
  
  
    <meta property="article:modified_time" content="2024-04-05T00:39:27&#43;08:00">
  






    






  




<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": "https://ikerlz.github.io/post/ddpm/"
  },
  "headline": "扩散模型（Diffusion Model）",
  
  "image": [
    "https://ikerlz.github.io/post/ddpm/featured.png"
  ],
  
  "datePublished": "2024-04-05T00:39:27+08:00",
  "dateModified": "2024-04-05T00:39:27+08:00",
  
  "author": {
    "@type": "Person",
    "name": "Zhe Li"
  },
  
  "publisher": {
    "@type": "Organization",
    "name": "Zhe Li",
    "logo": {
      "@type": "ImageObject",
      "url": "https://ikerlz.github.io/media/icon_hu9ccd2acdcd774e20fa34966445b706a8_6997380_192x192_fill_lanczos_center_3.png"
    }
  },
  "description": "主要针对扩散模型的一些经典文章写一些个人理解，博采众长，参考了很多博客、文章，详细信息见参考文献\nTable of Contents 0、文生图片模型 1、几种生成模型的对比 2、扩散模型（DDPM） 3 、基于分数的生成模型（Score-based generative models） 参考文献 0、文生图片模型 DALL·E 3 扩散模型的大火始于2020年所提出的DDPM（\u0026ldquo;Denoising Diffusion Probabilistic Models\u0026rdquo;）。当前最先进的两个文本生成图像——OpenAI的DALL·E 3和Google的Imagen 2，都是基于扩散模型来完成的。\n1、几种生成模型的对比 GAN（生成对抗网络）：GAN是由两部分组成，一个生成器和一个判别器。生成器的目标是创建足够真实的数据，以至于判别器不能区分生成的数据和真实数据。判别器的目标是正确区分真实数据和生成器生成的假数据。这两部分在训练过程中相互竞争，推动彼此的进步，因此称为对抗网络。GAN在图像生成方面尤其出色。\nVAE（变分自编码器）：VAE采用不同的方法来生成数据。它通过编码器将数据映射到一个分布上，并从这个分布中采样来构造一个解码器用于数据重建。它是一种通过概率方法生成新数据的模型，通常用于生成遵循特定统计分布的图片。\nFlow-based Models（基于流的模型）：这类模型使用可逆变换来学习数据的分布，这意味着它们可以精确地计算生成数据的概率。它们可以生成高质量的数据，并且给定新数据，也可以确定其概率。这种特性在密度估计和无损压缩方面特别有用。\nDiffusion Models（扩散模型）：Diffusion Models 的灵感来自non-equilibrium thermodynamics （非平衡热力学）。理论首先定义扩散步骤的马尔可夫链，以缓慢地将随机噪声添加到数据中，然后学习逆向扩散过程以从噪声中构造所需的数据样本。与 VAE 或流模型不同，扩散模型是通过固定过程学习，并且隐空间具有比较高的维度。"
}
</script>

  

  




  
  
  

  
  

  


  
  <title>扩散模型（Diffusion Model） | Zhe Li</title>

  
  
  
  











</head>


<body id="top" data-spy="scroll" data-offset="70" data-target="#TableOfContents" class="page-wrapper   " data-wc-page-id="92dbfd3e0804cc6aac84af0a6933bc2d" >

  
  
  
  
  
  
  
  
  
  <script src="/js/wowchemy-init.min.3a6bdbdff5d8a89d6e651adb3deec035.js"></script>

  


<aside class="search-modal" id="search">
  <div class="container">
    <section class="search-header">

      <div class="row no-gutters justify-content-between mb-3">
        <div class="col-6">
          <h1>Search</h1>
        </div>
        <div class="col-6 col-search-close">
          <a class="js-search" href="#" aria-label="Close"><i class="fas fa-times-circle text-muted" aria-hidden="true"></i></a>
        </div>
      </div>

      <div id="search-box">
        
        <input name="q" id="search-query" placeholder="Search..." autocapitalize="off"
        autocomplete="off" autocorrect="off" spellcheck="false" type="search" class="form-control"
        aria-label="Search...">
        
      </div>

      
      

      

    </section>
    <section class="section-search-results">

      <div id="search-hits">
        
      </div>

    </section>
  </div>
</aside>



  <div class="page-header header--fixed">
  
  
  
  
  












<header>
  <nav class="navbar navbar-expand-lg navbar-light compensate-for-scrollbar" id="navbar-main">
    <div class="container-xl">

      
      <div class="d-none d-lg-inline-flex">
        <a class="navbar-brand" href="/">Zhe Li</a>
      </div>
      

      
      <button type="button" class="navbar-toggler" data-toggle="collapse"
              data-target="#navbar-content" aria-controls="navbar-content" aria-expanded="false" aria-label="Toggle navigation">
      <span><i class="fas fa-bars"></i></span>
      </button>
      

      
      <div class="navbar-brand-mobile-wrapper d-inline-flex d-lg-none">
        <a class="navbar-brand" href="/">Zhe Li</a>
      </div>
      

      
      
      <div class="navbar-collapse main-menu-item collapse justify-content-start" id="navbar-content">

        
        <ul class="navbar-nav d-md-inline-flex">
          

          

          
          
          
            
          

          

          
          
          
          

          
            
              
              
            
            
              
              
              
                
              
              
            
          

          <li class="nav-item">
            <a class="nav-link " href="/#about"><span>Home</span></a>
          </li>

          
          

          

          
          
          
            
          

          

          
          
          
          

          
            
              
              
            
            
              
              
              
                
              
              
            
          

          <li class="nav-item">
            <a class="nav-link " href="/#publications"><span>Publications</span></a>
          </li>

          
          

          

          
          
          
            
          

          

          
          
          
          

          
            
              
              
            
            
              
              
              
                
              
              
            
          

          <li class="nav-item">
            <a class="nav-link " href="/#slides"><span>Slides</span></a>
          </li>

          
          

          

          
          
          
            
          

          

          
          
          
          

          
            
              
              
            
            
              
              
              
                
              
              
            
          

          <li class="nav-item">
            <a class="nav-link " href="/#posts"><span>Posts</span></a>
          </li>

          
          

          

          
          
          
            
          

          

          
          
          
          

          
            
              
              
            
            
              
              
              
                
              
              
            
          

          <li class="nav-item">
            <a class="nav-link " href="/#contact"><span>Contact</span></a>
          </li>

          
          

          

          
          
          
            
          

          

          
          
          
          

          
            
              
              
            
            
          

          <li class="nav-item">
            <a class="nav-link " href="/uploads/resume.pdf"><span>CV</span></a>
          </li>

          
          

        

          
        </ul>
      </div>

      <ul class="nav-icons navbar-nav flex-row ml-auto d-flex pl-md-2">

        
        
          
        

        
        
        
        <li class="nav-item">
          <a class="nav-link js-search" href="#" aria-label="Search"><i class="fas fa-search" aria-hidden="true"></i></a>
        </li>
        

        
        
        
        <li class="nav-item dropdown theme-dropdown">
          <a href="#" class="nav-link" data-toggle="dropdown" aria-haspopup="true" aria-label="Display preferences">
            <i class="fas fa-moon" aria-hidden="true"></i>
          </a>
          <div class="dropdown-menu">
            <a href="#" class="dropdown-item js-set-theme-light">
              <span>Light</span>
            </a>
            <a href="#" class="dropdown-item js-set-theme-dark">
              <span>Dark</span>
            </a>
            <a href="#" class="dropdown-item js-set-theme-auto">
              <span>Automatic</span>
            </a>
          </div>
        </li>
        

        
        

      </ul>

    </div>
  </nav>
</header>


  </div>

  <div class="page-body">
    
    
    

    <article class="article">

  






















  
  



<div class="article-container pt-3">
  <h1>扩散模型（Diffusion Model）</h1>

  

  


<div class="article-metadata">

  
  
  
  
  <div>
    

  <span >
      Zhe Li</span>
  </div>
  
  

  
  <span class="article-date">
    
    
      
    
    Apr 5, 2024
  </span>
  

  

  
  <span class="middot-divider"></span>
  <span class="article-reading-time">
    9 min read
  </span>
  

  
  
  
  

  
  
  <span class="middot-divider"></span>
  <span class="article-categories">
    <i class="fas fa-folder mr-1"></i><a href="/category/deep-learning/">Deep Learning</a></span>
  

</div>

  





</div>


<div class="article-header article-container featured-image-wrapper mt-4 mb-4" style="max-width: 720px; max-height: 411px;">
  <div style="position: relative">
    <img src="/post/ddpm/featured_hueb9b4963c2a48ef8eda9c604b41e6325_5525242_aa2bc1845b6e9d1b57f5408b1fa6bdcd.webp" width="720" height="411" alt="" class="featured-image">
    
  </div>
</div>



  <div class="article-container">

    <div class="article-style">
      <blockquote>
<p>主要针对扩散模型的一些经典文章写一些个人理解，博采众长，参考了很多博客、文章，详细信息见<a href="#%e5%8f%82%e8%80%83%e6%96%87%e7%8c%ae">参考文献</a></p>
</blockquote>


<details class="toc-inpage d-print-none  " open>
  <summary class="font-weight-bold">Table of Contents</summary>
  <nav id="TableOfContents">
  <ul>
    <li>
      <ul>
        <li><a href="#0文生图片模型">0、文生图片模型</a></li>
        <li><a href="#1几种生成模型的对比">1、几种生成模型的对比</a></li>
        <li><a href="#2扩散模型ddpm">2、扩散模型（DDPM）</a></li>
        <li><a href="#3-基于分数的生成模型score-based-generative-models">3 、基于分数的生成模型（Score-based generative models）</a></li>
        <li><a href="#参考文献">参考文献</a></li>
      </ul>
    </li>
  </ul>
</nav>
</details>

<h3 id="0文生图片模型">0、文生图片模型</h3>
<ul>
<li>DALL·E 3</li>
</ul>
<p>















<figure  >
  <div class="d-flex justify-content-center">
    <div class="w-100" ><img alt="" srcset="
               /media/posts/ddpm/fig1_hu1e16810cab0fdef8a3c7f055d86628b1_315476_d839474c362ab19b6de2a13f08f9b3fb.webp 400w,
               /media/posts/ddpm/fig1_hu1e16810cab0fdef8a3c7f055d86628b1_315476_3aa66a8c57ca28c59135515ff4051399.webp 760w,
               /media/posts/ddpm/fig1_hu1e16810cab0fdef8a3c7f055d86628b1_315476_1200x1200_fit_q75_h2_lanczos_3.webp 1200w"
               src="/media/posts/ddpm/fig1_hu1e16810cab0fdef8a3c7f055d86628b1_315476_d839474c362ab19b6de2a13f08f9b3fb.webp"
               width="760"
               height="625"
               loading="lazy" data-zoomable /></div>
  </div></figure>
</p>
<p>扩散模型的大火始于2020年所提出的DDPM（<a href="https://proceedings.neurips.cc/paper/2020/file/4c5bcfec8584af0d967f1ab10179ca4b-Paper.pdf" target="_blank" rel="noopener">&ldquo;Denoising Diffusion Probabilistic Models&rdquo;</a>）。当前最先进的两个文本生成图像——OpenAI的DALL·E 3和Google的Imagen 2，都是基于扩散模型来完成的。</p>
<hr>
<h3 id="1几种生成模型的对比">1、几种生成模型的对比</h3>
<p>















<figure  >
  <div class="d-flex justify-content-center">
    <div class="w-100" ><img alt="" srcset="
               /media/posts/ddpm/fig2_hucb6f640be08c90d6178259e0eccf4c36_525595_ed85736f85e08b4a3879ed404c3baed6.webp 400w,
               /media/posts/ddpm/fig2_hucb6f640be08c90d6178259e0eccf4c36_525595_ff4c893122c8087b276f842eb842bff1.webp 760w,
               /media/posts/ddpm/fig2_hucb6f640be08c90d6178259e0eccf4c36_525595_1200x1200_fit_q75_h2_lanczos_3.webp 1200w"
               src="/media/posts/ddpm/fig2_hucb6f640be08c90d6178259e0eccf4c36_525595_ed85736f85e08b4a3879ed404c3baed6.webp"
               width="760"
               height="526"
               loading="lazy" data-zoomable /></div>
  </div></figure>
</p>
<ul>
<li>
<p><strong>GAN（生成对抗网络）</strong>：GAN是由两部分组成，一个生成器和一个判别器。生成器的目标是创建足够真实的数据，以至于判别器不能区分生成的数据和真实数据。判别器的目标是正确区分真实数据和生成器生成的假数据。这两部分在训练过程中相互竞争，推动彼此的进步，因此称为对抗网络。GAN在图像生成方面尤其出色。</p>
</li>
<li>
<p><strong>VAE（变分自编码器）</strong>：VAE采用不同的方法来生成数据。它通过编码器将数据映射到一个分布上，并从这个分布中采样来构造一个解码器用于数据重建。它是一种通过概率方法生成新数据的模型，通常用于生成遵循特定统计分布的图片。</p>
</li>
<li>
<p><strong>Flow-based Models（基于流的模型）</strong>：这类模型使用可逆变换来学习数据的分布，这意味着它们可以精确地计算生成数据的概率。它们可以生成高质量的数据，并且给定新数据，也可以确定其概率。这种特性在密度估计和无损压缩方面特别有用。</p>
</li>
<li>
<p><strong>Diffusion Models（扩散模型）</strong>：Diffusion Models 的灵感来自non-equilibrium thermodynamics （非平衡热力学）。理论首先定义扩散步骤的马尔可夫链，以缓慢地将随机噪声添加到数据中，然后学习逆向扩散过程以从噪声中构造所需的数据样本。与 VAE 或流模型不同，扩散模型是通过固定过程学习，并且隐空间具有比较高的维度。</p>
</li>
</ul>
<h3 id="2扩散模型ddpm">2、扩散模型（DDPM）</h3>
<blockquote>
<p>主要参考<a href="https://www.bilibili.com/video/BV14c411J7f2/?spm_id_from=333.337.search-card.all.click&amp;vd_source=503c784d065197393158da59fb3ef766" target="_blank" rel="noopener">B站：李宏毅老师的 Diffusion Model 讲解</a></p>
</blockquote>
<p>考虑下图瑞士卷形状的二维联合概率分布$p(x,y)$，扩散过程$q$非常直观，本来集中有序的样本点，受到噪声的扰动，向外扩散，最终变成一个完全无序的噪声分布
















<figure  >
  <div class="d-flex justify-content-center">
    <div class="w-100" ><img alt="" srcset="
               /media/posts/ddpm/fig3_hu821fc73d96bb670162bc2e51d59cab7b_260304_34a2474f2f2ea2383b67148180ef013a.webp 400w,
               /media/posts/ddpm/fig3_hu821fc73d96bb670162bc2e51d59cab7b_260304_4da38fe1b89fcdda19319a92aa3ae4e5.webp 760w,
               /media/posts/ddpm/fig3_hu821fc73d96bb670162bc2e51d59cab7b_260304_1200x1200_fit_q75_h2_lanczos_3.webp 1200w"
               src="/media/posts/ddpm/fig3_hu821fc73d96bb670162bc2e51d59cab7b_260304_34a2474f2f2ea2383b67148180ef013a.webp"
               width="760"
               height="351"
               loading="lazy" data-zoomable /></div>
  </div></figure>

而diffusion model其实是图上的这个逆过程，将一个噪声分布$N(0,I)$逐步地去噪以映射到$p_{data}$，有了这样的映射，我们从噪声分布中采样，最终可以得到一张想要的图像。
















<figure  >
  <div class="d-flex justify-content-center">
    <div class="w-100" ><img alt="" srcset="
               /media/posts/ddpm/fig4_hu26b6188eab507b98056abd87a587f2b1_543246_85386dae27368958589a975cdaf9855b.webp 400w,
               /media/posts/ddpm/fig4_hu26b6188eab507b98056abd87a587f2b1_543246_6984f6ad32b9351b46424051252376ae.webp 760w,
               /media/posts/ddpm/fig4_hu26b6188eab507b98056abd87a587f2b1_543246_1200x1200_fit_q75_h2_lanczos.webp 1200w"
               src="/media/posts/ddpm/fig4_hu26b6188eab507b98056abd87a587f2b1_543246_85386dae27368958589a975cdaf9855b.webp"
               width="760"
               height="314"
               loading="lazy" data-zoomable /></div>
  </div></figure>
</p>
<h4 id="21-diffusion-model原理">2.1 Diffusion Model原理</h4>
<p>Diffusion Models由正向过程（或扩散过程）和反向过程（或逆扩散过程）组成：</p>
<ul>
<li>
<p>逆向过程（Inverse Process）
















<figure  >
  <div class="d-flex justify-content-center">
    <div class="w-100" ><img alt="" srcset="
               /media/posts/ddpm/fig5_hu7aea3f01016767d9da2ee599072df153_1208336_9b25e9a8239fa8496ba565538225f224.webp 400w,
               /media/posts/ddpm/fig5_hu7aea3f01016767d9da2ee599072df153_1208336_094c4a172f0574a17d93022df9adbfc3.webp 760w,
               /media/posts/ddpm/fig5_hu7aea3f01016767d9da2ee599072df153_1208336_1200x1200_fit_q75_h2_lanczos_3.webp 1200w"
               src="/media/posts/ddpm/fig5_hu7aea3f01016767d9da2ee599072df153_1208336_9b25e9a8239fa8496ba565538225f224.webp"
               width="760"
               height="348"
               loading="lazy" data-zoomable /></div>
  </div></figure>
</p>
</li>
<li>
<p>正向过程（Forward Process）
















<figure  >
  <div class="d-flex justify-content-center">
    <div class="w-100" ><img alt="" srcset="
               /media/posts/ddpm/fig10_hu8bfdc2e6fec0bc662b834b86bb424c05_150998_1fb069f3e54917294e3766e21cf44262.webp 400w,
               /media/posts/ddpm/fig10_hu8bfdc2e6fec0bc662b834b86bb424c05_150998_100888f7b50df7e19e3d9bea49401203.webp 760w,
               /media/posts/ddpm/fig10_hu8bfdc2e6fec0bc662b834b86bb424c05_150998_1200x1200_fit_q75_h2_lanczos_3.webp 1200w"
               src="/media/posts/ddpm/fig10_hu8bfdc2e6fec0bc662b834b86bb424c05_150998_1fb069f3e54917294e3766e21cf44262.webp"
               width="760"
               height="137"
               loading="lazy" data-zoomable /></div>
  </div></figure>
</p>
</li>
</ul>
<hr>
<p><strong>原文算法框</strong></p>
<p>















<figure  >
  <div class="d-flex justify-content-center">
    <div class="w-100" ><img alt="" srcset="
               /media/posts/ddpm/fig25_hub27644e6e15658d60eb80af72eb8a3ba_82961_70d9ad2cca2e81dad3cfa2cc3a4e0027.webp 400w,
               /media/posts/ddpm/fig25_hub27644e6e15658d60eb80af72eb8a3ba_82961_f5cf4e8c3068d0466d3d34b6c726cec0.webp 760w,
               /media/posts/ddpm/fig25_hub27644e6e15658d60eb80af72eb8a3ba_82961_1200x1200_fit_q75_h2_lanczos_3.webp 1200w"
               src="/media/posts/ddpm/fig25_hub27644e6e15658d60eb80af72eb8a3ba_82961_70d9ad2cca2e81dad3cfa2cc3a4e0027.webp"
               width="760"
               height="182"
               loading="lazy" data-zoomable /></div>
  </div></figure>
</p>
<hr>
<p><strong>Denoise Module</strong>
















<figure  >
  <div class="d-flex justify-content-center">
    <div class="w-100" ><img alt="" srcset="
               /media/posts/ddpm/fig6_hu0e91f38c452b01d88480c874d04bb6e9_434502_0a8f4e55e2da1824e098648a7f1576a0.webp 400w,
               /media/posts/ddpm/fig6_hu0e91f38c452b01d88480c874d04bb6e9_434502_4ff309f3f21cd1832811e7716496d175.webp 760w,
               /media/posts/ddpm/fig6_hu0e91f38c452b01d88480c874d04bb6e9_434502_1200x1200_fit_q75_h2_lanczos_3.webp 1200w"
               src="/media/posts/ddpm/fig6_hu0e91f38c452b01d88480c874d04bb6e9_434502_0a8f4e55e2da1824e098648a7f1576a0.webp"
               width="760"
               height="336"
               loading="lazy" data-zoomable /></div>
  </div></figure>
</p>
<p><strong>如何训练</strong>
















<figure  >
  <div class="d-flex justify-content-center">
    <div class="w-100" ><img alt="" srcset="
               /media/posts/ddpm/fig7_hue760546b5339ff73f2e1c0885d259cd7_2140973_54aa961493db2ced61dbbe6ebdd2e34a.webp 400w,
               /media/posts/ddpm/fig7_hue760546b5339ff73f2e1c0885d259cd7_2140973_d7f707455c1f6e5260a220b5f55ae850.webp 760w,
               /media/posts/ddpm/fig7_hue760546b5339ff73f2e1c0885d259cd7_2140973_1200x1200_fit_q75_h2_lanczos_3.webp 1200w"
               src="/media/posts/ddpm/fig7_hue760546b5339ff73f2e1c0885d259cd7_2140973_54aa961493db2ced61dbbe6ebdd2e34a.webp"
               width="760"
               height="386"
               loading="lazy" data-zoomable /></div>
  </div></figure>
</p>
<p><strong>如何从文本生成图片</strong>
















<figure  >
  <div class="d-flex justify-content-center">
    <div class="w-100" ><img alt="" srcset="
               /media/posts/ddpm/fig8_hu07a283b9f2fe30b8f42b861660e27d35_1239135_d0dca45ce64a4972fe2e9672fd298e17.webp 400w,
               /media/posts/ddpm/fig8_hu07a283b9f2fe30b8f42b861660e27d35_1239135_b1adb5541035b0da3c2cd1cb0cc6bc41.webp 760w,
               /media/posts/ddpm/fig8_hu07a283b9f2fe30b8f42b861660e27d35_1239135_1200x1200_fit_q75_h2_lanczos_3.webp 1200w"
               src="/media/posts/ddpm/fig8_hu07a283b9f2fe30b8f42b861660e27d35_1239135_d0dca45ce64a4972fe2e9672fd298e17.webp"
               width="760"
               height="322"
               loading="lazy" data-zoomable /></div>
  </div></figure>

















<figure  >
  <div class="d-flex justify-content-center">
    <div class="w-100" ><img alt="" srcset="
               /media/posts/ddpm/fig9_hu77b70742483f8616b3f219bbbb608587_777210_f86ec8143aa20281536c1411adf6d0f3.webp 400w,
               /media/posts/ddpm/fig9_hu77b70742483f8616b3f219bbbb608587_777210_c7b154285229bab0b4b15a1845b4a4a2.webp 760w,
               /media/posts/ddpm/fig9_hu77b70742483f8616b3f219bbbb608587_777210_1200x1200_fit_q75_h2_lanczos_3.webp 1200w"
               src="/media/posts/ddpm/fig9_hu77b70742483f8616b3f219bbbb608587_777210_f86ec8143aa20281536c1411adf6d0f3.webp"
               width="760"
               height="428"
               loading="lazy" data-zoomable /></div>
  </div></figure>
</p>
<h4 id="22-ddpm-数学推导">2.2 DDPM 数学推导</h4>
<p>















<figure  >
  <div class="d-flex justify-content-center">
    <div class="w-100" ><img alt="" srcset="
               /media/posts/ddpm/fig11_huf2fa0849d9c18b9d3f38f919f7dbbefd_89863_0647271d198440857855456cd0887d31.webp 400w,
               /media/posts/ddpm/fig11_huf2fa0849d9c18b9d3f38f919f7dbbefd_89863_4f758a954266206f53c913a1a258e674.webp 760w,
               /media/posts/ddpm/fig11_huf2fa0849d9c18b9d3f38f919f7dbbefd_89863_1200x1200_fit_q75_h2_lanczos_3.webp 1200w"
               src="/media/posts/ddpm/fig11_huf2fa0849d9c18b9d3f38f919f7dbbefd_89863_0647271d198440857855456cd0887d31.webp"
               width="760"
               height="355"
               loading="lazy" data-zoomable /></div>
  </div></figure>

我们可以从MLE的角度来理解图片生成模型，即我们希望随机抽样一个$z$后，经过一个“参数模型”（神经网络）输出的$P_\theta(x)$这个分布与真实的数据分布$P_{data}(x)$越近越好，因此我们希望找到一个$\theta$，使其对于从$P_{data}(x)$中抽样出来的$m$个样本$\{x^1,x^2,\ldots,x^m\}$满足：
$$\theta^\star=\arg \max _\theta \prod_{i=1}^m P_\theta\left(x^i\right)$$
因此，本质上就是最大化似然。进一步，我们可以得到：
$$
\begin{aligned}
\theta^\star= &amp; \arg \max _\theta \prod_{i=1}^m P_\theta\left(x^i\right)=\arg \max _\theta \sum_{i=1}^m \log P_\theta\left(x^i\right)\\
&amp; \approx \arg \max _\theta E_{x \sim P_{\text {data }}}\left[\log P_\theta(x)\right] \\
&amp;=\arg \max _\theta \int_x P_{\text {data }}(x) \log P_\theta(x) d x\\
&amp; ={\small \arg \max _\theta \left\{\int_x P_{\text {data }}(x) \log P_\theta(x) d x-{\color{blue}\int_x P_{\text {data }}(x) \log P_{\text {data }}(x) d x}\right\}} \\
&amp; =\arg \max _\theta \int_x P_{\text {data }}(x) \log \frac{P_\theta(x)}{P_{\text {data }}(x)} d x\\
&amp; = \arg\min_{\theta} {\color{blue}KL (P_{\text {data }}\| P_\theta)}
\end{aligned}
$$
所以最大化似然等价于最小化真实数据分布与生成数据分布的KL散度。但是一般说来，直接计算$P_\theta(x)$是非常困难的，在VAE我们是通过计算$\log\{P(x)\}$的下界来优化网络的，具体而言，给定任意一个分布$q(z|x)$，我们有
$$
\begin{aligned}
&amp; \log P(x)\\
=&amp;\int_z q(z \mid x) \log P(x) d z \\
=&amp;\int_z q(z \mid x) \log \left(\frac{P(z, x)}{P(z \mid x)}\right) d z\\
=&amp;\int_z q(z \mid x) \log \left(\frac{P(z, x)}{{\color{blue}q(z \mid x)}} \frac{{\color{blue}q(z \mid x)}}{P(z \mid x)}\right) d z \\
=&amp; \int_z q(z \mid x) \log \left(\frac{P(z, x)}{q(z \mid x)}\right) d z+\underbrace{\int_z q(z \mid x) \log \left(\frac{q(z \mid x)}{P(z \mid x)}\right) d z}_{{\color{red}K L(q(z \mid x) | P(z \mid x))\ge 0}}  \\
\geq &amp; \int_z q(z \mid x) \log \left(\frac{P(z, x)}{q(z \mid x)}\right) d z\\
=&amp;\mathrm{E}_{q(z \mid x)}\left[\log \left(\frac{P(x, z)}{q(z \mid x)}\right)\right]
\end{aligned}
$$
这里的$\mathrm{E}_{q(z \mid x)}\left[\log \left(\frac{P(x, z)}{q(z \mid x)}\right)\right]$就是$\log P(x)$的下界（ELBO(evidence lower-bound)），在VAE中，我们本质上是在Maximize这个下界，这里$q(z\mid x)$实际上就是VAE中的Encoder。至于$P(x,z)$这个联合分布，我们可以借助公式$P(x,z)=P(x \mid z)P(z)$来计算，$P(z)$通常假设为高斯分布。至于$P(x \mid z)$的计算，如下图所示，随机生成一个$z$后，输入网络中得到$G(z)$，我们希望$G(z)$与$x$越近越好，因此，最直接的想法是：
$$
P_\theta(x \mid z)= \begin{cases}1, &amp; G(z)=x \\ 0, &amp; G(z) \neq x\end{cases}
$$
















<figure  >
  <div class="d-flex justify-content-center">
    <div class="w-100" ><img alt="" srcset="
               /media/posts/ddpm/fig12_hua02dbfdc2ef7699e593e9be777735686_69741_1be4a558ca0f81c17aaff41583c2bc4a.webp 400w,
               /media/posts/ddpm/fig12_hua02dbfdc2ef7699e593e9be777735686_69741_0e109b27b730859f5f94e2ef0edd4901.webp 760w,
               /media/posts/ddpm/fig12_hua02dbfdc2ef7699e593e9be777735686_69741_1200x1200_fit_q75_h2_lanczos_3.webp 1200w"
               src="/media/posts/ddpm/fig12_hua02dbfdc2ef7699e593e9be777735686_69741_1be4a558ca0f81c17aaff41583c2bc4a.webp"
               width="632"
               height="444"
               loading="lazy" data-zoomable /></div>
  </div></figure>

但是这样可能会导致$P_\theta(x \mid z)$几乎都是0。因此我们可以把假设$P_\theta(x\mid z)$服从一个均值为$G(z)$的高斯分布，这样$P_\theta(x\mid z)\propto \exp \left(-\|G(z)-x\|_2^2\right)$，就进行训练（当然，这里只是为了解释$P_\theta(x\mid z)$的计算，VAE实际操作中还涉及到重参数化的技巧等等，这里就不再赘述）
根据相同的思路，我们就可以计算这个DDPM中的$P_\theta(x_0)$：
















<figure  >
  <div class="d-flex justify-content-center">
    <div class="w-100" ><img alt="" srcset="
               /media/posts/ddpm/fig13_hu8be117594e72e0473dfe5bb163641514_199145_f52a73409331a6bd504c815b1fe80a73.webp 400w,
               /media/posts/ddpm/fig13_hu8be117594e72e0473dfe5bb163641514_199145_de895675f0048aed8f97d226b65fd7b5.webp 760w,
               /media/posts/ddpm/fig13_hu8be117594e72e0473dfe5bb163641514_199145_1200x1200_fit_q75_h2_lanczos_3.webp 1200w"
               src="/media/posts/ddpm/fig13_hu8be117594e72e0473dfe5bb163641514_199145_f52a73409331a6bd504c815b1fe80a73.webp"
               width="760"
               height="222"
               loading="lazy" data-zoomable /></div>
  </div></figure>

如上图所示，我们可以把$P_\theta(x_{t-1}\mid x_t)$看作是服从均值为$G(x_t)$的高斯分布，因此$P_\theta(x_{t-1}\mid x_t)\propto \exp \left(-\|G(x_t)-x_{t-1}\|_2^2\right)$，同时我们假设一阶马尔可夫条件，最终得到：
$$
{\small P_\theta\left(x_0\right)=\int_{x_1: x_T} P\left(x_T\right) P_\theta\left(x_{T-1} \mid x_T\right) \ldots P_\theta\left(x_{t-1} \mid x_t\right) \ldots P_\theta\left(x_0 \mid x_1\right) d x_1: x_T}
$$
如下图所示，如果我们对比VAE和DDPM，两者在形式上是非常相似的：
















<figure  >
  <div class="d-flex justify-content-center">
    <div class="w-100" ><img alt="" srcset="
               /media/posts/ddpm/fig14_hu0b21a8c49959ecddac23906f97c2b114_53574_705b8e0e697b6a81819b739f666dffb3.webp 400w,
               /media/posts/ddpm/fig14_hu0b21a8c49959ecddac23906f97c2b114_53574_ddf41f58fe893b5fe8b75a7ca880b23e.webp 760w,
               /media/posts/ddpm/fig14_hu0b21a8c49959ecddac23906f97c2b114_53574_1200x1200_fit_q75_h2_lanczos_3.webp 1200w"
               src="/media/posts/ddpm/fig14_hu0b21a8c49959ecddac23906f97c2b114_53574_705b8e0e697b6a81819b739f666dffb3.webp"
               width="760"
               height="217"
               loading="lazy" data-zoomable /></div>
  </div></figure>

这里的$q\left(x_1: x_T \mid x_0\right)$我们仍然可以在假设一阶马尔可夫的条件下拆分为：
$$q\left(x_1: x_T \mid x_0\right)=q\left(x_1 \mid x_0\right) q\left(x_2 \mid x_1\right) \ldots q\left(x_T \mid x_{T-1}\right)$$
那么，这里的$q(x_t\mid x_{t-1})$应该怎么计算呢？
















<figure  >
  <div class="d-flex justify-content-center">
    <div class="w-100" ><img alt="" srcset="
               /media/posts/ddpm/fig15_hu876d3a5c98e047e2dadaa9a9ea215024_1046707_11ecf189d0db3c5cffc93f39ae75201a.webp 400w,
               /media/posts/ddpm/fig15_hu876d3a5c98e047e2dadaa9a9ea215024_1046707_325b391a868fff9e997eb549a47c6ebd.webp 760w,
               /media/posts/ddpm/fig15_hu876d3a5c98e047e2dadaa9a9ea215024_1046707_1200x1200_fit_q75_h2_lanczos_3.webp 1200w"
               src="/media/posts/ddpm/fig15_hu876d3a5c98e047e2dadaa9a9ea215024_1046707_11ecf189d0db3c5cffc93f39ae75201a.webp"
               width="760"
               height="168"
               loading="lazy" data-zoomable /></div>
  </div></figure>

由于在扩散过程（Diffusion Process）中，$x_t$满足$x_t=\sqrt{1-\beta_t}x_{t-1}+\sqrt{\beta_t}\epsilon_{t-1}$，其中$\epsilon_{t-1}\sim N(0,I)$，因此，我们$x_t$服从均值为$\sqrt{1-\beta_t}x_{t-1}$，方差为$\beta_t$的高斯分布，从而可以很好地进行计算。另外，对于$q(x_t\mid x_0)$，我们并不需要通过$q(x_t\mid x_0)=q(x_t\mid x_{t-1})q(x_{t-1}\mid x_{t-2})\cdots q(x_1\mid x_0)$这个序列每次抽样一个高斯分布，逐一计算，然后乘起来，我们可以直接计算$q(x_t\mid x_0)$，原因如下图所示：
















<figure  >
  <div class="d-flex justify-content-center">
    <div class="w-100" ><img alt="" srcset="
               /media/posts/ddpm/fig16_hub9a88944aad38652fab818f85290f39d_802773_596576daadc60690d83215eac446c5b7.webp 400w,
               /media/posts/ddpm/fig16_hub9a88944aad38652fab818f85290f39d_802773_550d50cc68b71be43be51893914faaf5.webp 760w,
               /media/posts/ddpm/fig16_hub9a88944aad38652fab818f85290f39d_802773_1200x1200_fit_q75_h2_lanczos_3.webp 1200w"
               src="/media/posts/ddpm/fig16_hub9a88944aad38652fab818f85290f39d_802773_596576daadc60690d83215eac446c5b7.webp"
               width="760"
               height="466"
               loading="lazy" data-zoomable /></div>
  </div></figure>

由于两次抽样是相互独立的，因此我可以只抽样一次，然后修改系数即可：
















<figure  >
  <div class="d-flex justify-content-center">
    <div class="w-100" ><img alt="" srcset="
               /media/posts/ddpm/fig17_hucd2b878f290493e25e2d963d4cbcc8c6_960995_38f59c4aab34d15e1ff9397930fce3b7.webp 400w,
               /media/posts/ddpm/fig17_hucd2b878f290493e25e2d963d4cbcc8c6_960995_9664255e64588c51cd8a7553dd2a9e34.webp 760w,
               /media/posts/ddpm/fig17_hucd2b878f290493e25e2d963d4cbcc8c6_960995_1200x1200_fit_q75_h2_lanczos_3.webp 1200w"
               src="/media/posts/ddpm/fig17_hucd2b878f290493e25e2d963d4cbcc8c6_960995_38f59c4aab34d15e1ff9397930fce3b7.webp"
               width="760"
               height="126"
               loading="lazy" data-zoomable /></div>
  </div></figure>

以此类推，我们有
$$
\begin{aligned}
x_t &amp;= \sqrt{(1-\beta_t)(1-\beta_{t-1})\ldots(1-\beta_1)}x_0\\
&amp;~~~+ \sqrt{1-(1-\beta_t)(1-\beta_{t-1})\ldots(1-\beta_1)}\ \epsilon
\end{aligned}
$$
这里的$\beta_1,\beta_2,\ldots,\beta_T$都是在训练之前人为设定的参数，如果我们定义$\alpha_t=1-\beta$，$\bar\alpha_t=\alpha_1\alpha_2\ldots \alpha_t$，我们就得到了论文中的表达式：
$$
\begin{aligned}
x_t &amp;= \sqrt{\bar\alpha_t}x_0+ \sqrt{1-\bar\alpha_t}\ \epsilon
\end{aligned}
$$
我们回到优化目标：
$$
\operatorname{Maximize}\quad \mathrm{E}_{q\left(x_1: x_T \mid x_0\right)}\left[\log \left(\frac{P\left(x_0: x_T\right)}{q\left(x_1: x_T \mid x_0\right)}\right)\right]
$$
在“<a href="https://arxiv.org/pdf/2208.11970.pdf" target="_blank" rel="noopener">Understanding Diffusion Models: A Unified Perspective</a>”这篇文章中，对上述目标函数进行了推导：</p>
<p>$$
\begin{aligned}
&amp; \log p(\boldsymbol{x}) \geq \mathbb{E}_{q\left(\boldsymbol{x}_{1: T} \mid \boldsymbol{x}_0\right)}\left[\log \frac{p\left(\boldsymbol{x}_{0: T}\right)}{q\left(\boldsymbol{x}_{1: T} \mid \boldsymbol{x}_0\right)}\right] \\
&amp; =\mathbb{E}_{q\left(\boldsymbol{x}_{1: T} \mid \boldsymbol{x}_0\right)}\left[\log \frac{p\left(\boldsymbol{x}_T\right) \prod_{t=1}^T p_{\boldsymbol{\theta}}\left(\boldsymbol{x}_{t-1} \mid \boldsymbol{x}_t\right)}{\prod_{t=1}^T q\left(\boldsymbol{x}_t \mid \boldsymbol{x}_{t-1}\right)}\right] \\
&amp; =\mathbb{E}_{q\left(\boldsymbol{x}_{1: T} \mid \boldsymbol{x}_0\right)}\left[\log \frac{p\left(\boldsymbol{x}_T\right) p_{\boldsymbol{\theta}}\left(\boldsymbol{x}_0 \mid \boldsymbol{x}_1\right) \prod_{t=2}^T p_{\boldsymbol{\theta}}\left(\boldsymbol{x}_{t-1} \mid \boldsymbol{x}_t\right)}{q\left(\boldsymbol{x}_1 \mid \boldsymbol{x}_0\right) \prod_{t=2}^T q\left(\boldsymbol{x}_t \mid \boldsymbol{x}_{t-1}\right)}\right] \\
&amp; =\mathbb{E}_{q\left(\boldsymbol{x}_{1: T} \mid \boldsymbol{x}_0\right)}\left[\log \frac{p\left(\boldsymbol{x}_T\right) p_{\boldsymbol{\theta}}\left(\boldsymbol{x}_0 \mid \boldsymbol{x}_1\right) \prod_{t=2}^T p_{\boldsymbol{\theta}}\left(\boldsymbol{x}_{t-1} \mid \boldsymbol{x}_t\right)}{q\left(\boldsymbol{x}_1 \mid \boldsymbol{x}_0\right) \prod_{t=2}^T q\left(\boldsymbol{x}_t \mid \boldsymbol{x}_{t-1}, \boldsymbol{x}_0\right)}\right] \\
&amp; =\mathbb{E}_{q\left(\boldsymbol{x}_{1: T} \mid \boldsymbol{x}_0\right)}\left[\log \frac{p_{\boldsymbol{\theta}}\left(\boldsymbol{x}_T\right) p_{\boldsymbol{\theta}}\left(\boldsymbol{x}_0 \mid \boldsymbol{x}_1\right)}{q\left(\boldsymbol{x}_1 \mid \boldsymbol{x}_0\right)}+\log \prod_{t=2}^T \frac{p_{\boldsymbol{\theta}}\left(\boldsymbol{x}_{t-1} \mid \boldsymbol{x}_t\right)}{q\left(\boldsymbol{x}_t \mid \boldsymbol{x}_{t-1}, \boldsymbol{x}_0\right)}\right] \\
&amp; =\mathbb{E}_{q\left(\boldsymbol{x}_{1: T} \mid \boldsymbol{x}_0\right)}\left[\log \frac{p\left(\boldsymbol{x}_T\right) p_{\boldsymbol{\theta}}\left(\boldsymbol{x}_0 \mid \boldsymbol{x}_1\right)}{q\left(\boldsymbol{x}_1 \mid \boldsymbol{x}_0\right)}+\log \prod_{t=2}^T \frac{p_{\boldsymbol{\theta}}\left(\boldsymbol{x}_{t-1} \mid \boldsymbol{x}_t\right)}{\frac{q\left(\boldsymbol{x}_{t-1} \mid \boldsymbol{x}_t, \boldsymbol{x}_0\right) q\left(\boldsymbol{x}_t \mid \boldsymbol{x}_0\right)}{q\left(\boldsymbol{x}_{t-1} \mid \boldsymbol{x}_0\right)}}\right] \\
&amp; =\mathbb{E}_{q\left(\boldsymbol{x}_{1: T} \mid \boldsymbol{x}_0\right)}\left[\log \frac{p\left(\boldsymbol{x}_T\right) p_{\boldsymbol{\theta}}\left(\boldsymbol{x}_0 \mid \boldsymbol{x}_1\right)}{q\left(\boldsymbol{x}_1 \mid \boldsymbol{x}_0\right)}+\log \prod_{t=2}^T \frac{p_{\boldsymbol{\theta}}\left(\boldsymbol{x}_{t-1} \mid \boldsymbol{x}_t\right)}{\frac{q\left(\boldsymbol{x}_{t-1} \mid \boldsymbol{x}_t, \boldsymbol{x}_0\right) q\left(\boldsymbol{x}_t+\boldsymbol{x}_0\right)}{q\left(\boldsymbol{x}_{t-1} \mid \boldsymbol{x}_0\right)}}\right] \\
&amp; =\mathbb{E}_{q\left(\boldsymbol{x}_{1: T} \mid \boldsymbol{x}_0\right)}\left[\log \frac{p\left(\boldsymbol{x}_T\right) p_{\boldsymbol{\theta}}\left(\boldsymbol{x}_0 \mid \boldsymbol{x}_1\right)}{q\left(\boldsymbol{x}_1 \mid \boldsymbol{x}_0\right)}+\log \frac{q\left(\boldsymbol{x}_1 \mid \boldsymbol{x}_0\right)}{q\left(\boldsymbol{x}_T \mid \boldsymbol{x}_0\right)}\right.\\
&amp;~~~~~~~~~~~~~~~~~~~~~~~~+\left.\log \prod_{t=2}^T \frac{p_{\boldsymbol{\theta}}\left(\boldsymbol{x}_{t-1} \mid \boldsymbol{x}_t\right)}{q\left(\boldsymbol{x}_{t-1} \mid \boldsymbol{x}_t, \boldsymbol{x}_0\right)}\right] \\
&amp; =\mathbb{E}_{q\left(\boldsymbol{x}_{1: T} \mid \boldsymbol{x}_0\right)}\left[\log \frac{p\left(\boldsymbol{x}_T\right) p_{\boldsymbol{\theta}}\left(\boldsymbol{x}_0 \mid \boldsymbol{x}_1\right)}{q\left(\boldsymbol{x}_T \mid \boldsymbol{x}_0\right)}+\sum_{t=2}^T \log \frac{p_{\boldsymbol{\theta}}\left(\boldsymbol{x}_{t-1} \mid \boldsymbol{x}_t\right)}{q\left(\boldsymbol{x}_{t-1} \mid \boldsymbol{x}_t, \boldsymbol{x}_0\right)}\right] \\
&amp; =\mathbb{E}_{q\left(\boldsymbol{x}_{1: T} \mid \boldsymbol{x}_0\right)}\left[\log p_{\boldsymbol{\theta}}\left(\boldsymbol{x}_0 \mid \boldsymbol{x}_1\right)\right]+\mathbb{E}_{q\left(\boldsymbol{x}_{1: T} \mid \boldsymbol{x}_0\right)}\left[\log \frac{p\left(\boldsymbol{x}_T\right)}{q\left(\boldsymbol{x}_T \mid \boldsymbol{x}_0\right)}\right]\\
&amp; ~~~~~~~~~ \qquad \qquad  +\sum_{t=2}^T \mathbb{E}_{q\left(\boldsymbol{x}_{1: T} \mid \boldsymbol{x}_0\right)}\left[\log \frac{p_{\boldsymbol{\theta}}\left(\boldsymbol{x}_{t-1} \mid \boldsymbol{x}_t\right)}{q\left(\boldsymbol{x}_{t-1} \mid \boldsymbol{x}_t, \boldsymbol{x}_0\right)}\right] \\
&amp; =\mathbb{E}_{q\left(\boldsymbol{x}_1 \mid \boldsymbol{x}_0\right)}\left[\log p_{\boldsymbol{\theta}}\left(\boldsymbol{x}_0 \mid \boldsymbol{x}_1\right)\right]+\mathbb{E}_{q\left(\boldsymbol{x}_T \mid \boldsymbol{x}_0\right)}\left[\log \frac{p\left(\boldsymbol{x}_T\right)}{q\left(\boldsymbol{x}_T \mid \boldsymbol{x}_0\right)}\right]\\
&amp; ~~~~~~~~~ \qquad \qquad  +\sum_{t=2}^T \mathbb{E}_{q\left(\boldsymbol{x}_t, \boldsymbol{x}_{t-1} \mid \boldsymbol{x}_0\right)}\left[\log \frac{p_{\boldsymbol{\theta}}\left(\boldsymbol{x}_{t-1} \mid \boldsymbol{x}_t\right)}{q\left(\boldsymbol{x}_{t-1} \mid \boldsymbol{x}_t, \boldsymbol{x}_0\right)}\right] \\
&amp; =\underbrace{\mathbb{E}_{q\left(\boldsymbol{x}_1 \mid \boldsymbol{x}_0\right)}\left[\log p_{\boldsymbol{\theta}}\left(\boldsymbol{x}_0 \mid \boldsymbol{x}_1\right)\right]}_{\text {reconstruction term }}-\underbrace{D_{\mathrm{KL}}\left(q\left(\boldsymbol{x}_T \mid \boldsymbol{x}_0\right) \| p\left(\boldsymbol{x}_T\right)\right)}_{\text {prior matching term }}\\
&amp; ~~~~~~~~~ \qquad \qquad  -\sum_{t=2}^T \underbrace{\mathbb{E}_{q\left(\boldsymbol{x}_t \mid \boldsymbol{x}_0\right)}\left[D_{\mathrm{KL}}\left(q\left(\boldsymbol{x}_{t-1} \mid \boldsymbol{x}_t, \boldsymbol{x}_0\right) \| p_{\boldsymbol{\theta}}\left(\boldsymbol{x}_{t-1} \mid \boldsymbol{x}_t\right)\right)\right]}_{\text {denoising matching term }}
\end{aligned}
$$
因此，我们得到了DDPM中$\log P(x)$的lower bound：
$$
\begin{aligned}
&amp;\mathrm{E}_{q\left(x_1 \mid x_0\right)}\left[\log P\left(x_0 \mid x_1\right)\right]  -K L\left(q\left(x_T \mid x_0\right)|| P\left(x_T\right)\right) \\
&amp; ~~~ \qquad -\sum_{t=2}^T \mathrm{E}_{q\left(x_t \mid x_0\right)}\left[K L\left(q\left(x_{t-1} \mid x_t, x_0\right)\| P\left(x_{t-1} \mid x_t\right)\right)\right]
\end{aligned}
$$
我们并不需要计算$K L\left(q\left(x_T \mid x_0\right)|| P\left(x_T\right)\right)$，因为这里的$P\left(x_T\right)$是从高斯分布中采样，而$q\left(x_T \mid x_0\right)$是我们人为设定的 diffusion process，这两个分布均于神经网络参数$\theta$无关，可以视为一个常数。我们重点关注的应该是最后一项$\sum_{t=2}^T \mathrm{E}_{q\left(x_t \mid x_0\right)}\left[K L\left(q\left(x_{t-1} \mid x_t, x_0\right)\| P\left(x_{t-1} \mid x_t\right)\right)\right]$，至于第一项，优化的思路类似于最后一项，这里不再展开，详细的情况可以参看原论文或<a href="https://zhuanlan.zhihu.com/p/549623622" target="_blank" rel="noopener">（Diffusion Models：生成扩散模型-知乎）</a>。对于$\sum_{t=2}^T \mathrm{E}_{q\left(x_t \mid x_0\right)}\left[K L\left(q\left(x_{t-1} \mid x_t, x_0\right)\| P\left(x_{t-1} \mid x_t\right)\right)\right]$这一项，难点在于计算$q\left(x_{t-1} \mid x_t, x_0\right)$，由于我们可以计算$q\left(x_{t} \mid x_0\right)$, $q\left(x_{t-1} \mid x_0\right)$以及$q\left(x_{t} \mid x_{t-1}\right)$：
















<figure  >
  <div class="d-flex justify-content-center">
    <div class="w-100" ><img alt="" srcset="
               /media/posts/ddpm/fig18_hu2ad81eb2a30207fc03d0722a4d476e66_693698_bf42de8eca1531801932d4f820ac6a6b.webp 400w,
               /media/posts/ddpm/fig18_hu2ad81eb2a30207fc03d0722a4d476e66_693698_439fd90de5246b7a6ce5b8bc313e2349.webp 760w,
               /media/posts/ddpm/fig18_hu2ad81eb2a30207fc03d0722a4d476e66_693698_1200x1200_fit_q75_h2_lanczos_3.webp 1200w"
               src="/media/posts/ddpm/fig18_hu2ad81eb2a30207fc03d0722a4d476e66_693698_bf42de8eca1531801932d4f820ac6a6b.webp"
               width="760"
               height="265"
               loading="lazy" data-zoomable /></div>
  </div></figure>

因此，利用条件概率公式得：
$$
\begin{aligned}
q\left(x_{t-1} \mid x_t, x_0\right)&amp;=\frac{q\left(x_{t-1}, x_t, x_0\right)}{q\left(x_t, x_0\right)}=\frac{q\left(x_t \mid x_{t-1}\right) q\left(x_{t-1} \mid x_0\right) q\left(x_0\right)}{q\left(x_t \mid x_0\right) q\left(x_0\right)}\\
&amp;=\frac{q\left(x_t \mid x_{t-1}\right) q\left(x_{t-1} \mid x_0\right)}{q\left(x_t \mid x_0\right)}
\end{aligned}
$$
将$q\left(x_{t} \mid x_0\right)$, $q\left(x_{t-1} \mid x_0\right)$以及$q\left(x_{t} \mid x_{t-1}\right)$这三个的具体表达式代入后，我们可以得到：
















<figure  >
  <div class="d-flex justify-content-center">
    <div class="w-100" ><img alt="" srcset="
               /media/posts/ddpm/fig19_hu4002690b8a073c8e34ccfaa35295ed29_158246_e55fbeabc1b83bda88ae8a1bf7a776eb.webp 400w,
               /media/posts/ddpm/fig19_hu4002690b8a073c8e34ccfaa35295ed29_158246_743269468c38b38d2fa64dab9f3d187c.webp 760w,
               /media/posts/ddpm/fig19_hu4002690b8a073c8e34ccfaa35295ed29_158246_1200x1200_fit_q75_h2_lanczos_3.webp 1200w"
               src="/media/posts/ddpm/fig19_hu4002690b8a073c8e34ccfaa35295ed29_158246_e55fbeabc1b83bda88ae8a1bf7a776eb.webp"
               width="760"
               height="721"
               loading="lazy" data-zoomable /></div>
  </div></figure>

我们发现$q\left(x_{t-1} \mid x_t, x_0\right)$仍然是一个高斯分布，均值和方差分别为：
$$
\begin{aligned}
{\mu_q\left(\boldsymbol{x}_t, \boldsymbol{x}_0\right)} &amp;= {\frac{\sqrt{\alpha_t}\left(1-\bar{\alpha}_{t-1}\right) \boldsymbol{x}_t+\sqrt{\bar{\alpha}_{t-1}}\left(1-\alpha_t\right) \boldsymbol{x}_0}{1-\bar{\alpha}_t}}\\
\boldsymbol{\Sigma}_q(t) &amp;= {\frac{\left(1-\alpha_t\right)\left(1-\bar{\alpha}_{t-1}\right)}{1-\bar{\alpha}_t}\mathbf{I}}
\end{aligned}
$$</p>
<p>既然$q\left(x_{t-1} \mid x_t, x_0\right)$与$P\left(x_{t-1} \mid x_t\right)$均为高斯分布，那么KL散度是有显示解的，即：
$$
\begin{aligned}
&amp; D_{\mathrm{KL}}\left(\mathcal{N}\left(\boldsymbol{x} ; \boldsymbol{\mu}_x, \boldsymbol{\Sigma}_x\right) | \mathcal{N}\left(\boldsymbol{y} ; \boldsymbol{\mu}_y, \boldsymbol{\Sigma}_y\right)\right)\\
=&amp;\frac{1}{2}\left[\log \frac{\left|\boldsymbol{\Sigma}_y\right|}{\left|\boldsymbol{\Sigma}_x\right|}-d+\operatorname{tr}\left(\boldsymbol{\Sigma}_y^{-1} \boldsymbol{\Sigma}_x\right)+\left(\boldsymbol{\mu}_y-\boldsymbol{\mu}_x\right)^T \boldsymbol{\Sigma}_y^{-1}\left(\boldsymbol{\mu}_y-\boldsymbol{\mu}_x\right)\right]
\end{aligned}
$$</p>
<p>但是我们有更简单的方法来替代KL散度的计算，具体而言，我们注意到$q\left(x_{t-1} \mid x_t, x_0\right)$是一个跟网络参数无关的高斯分布，因此其均值和方差都是固定的，而$P\left(x_{t-1} \mid x_t\right)$中，我们会控制 Denoise 的方差，但是其均值是更网络参数有关的，因此我们只需要让这两个分布的均值接近就可以，这就等价于最小化KL散度
















<figure  >
  <div class="d-flex justify-content-center">
    <div class="w-100" ><img alt="" srcset="
               /media/posts/ddpm/fig20_hu8ace829d78d9a17233afe6a958d29f16_189358_c08539eca563fdf6d13ac365cfd50cf6.webp 400w,
               /media/posts/ddpm/fig20_hu8ace829d78d9a17233afe6a958d29f16_189358_3115d3e08111d8f466a68ac116a669a7.webp 760w,
               /media/posts/ddpm/fig20_hu8ace829d78d9a17233afe6a958d29f16_189358_1200x1200_fit_q75_h2_lanczos_3.webp 1200w"
               src="/media/posts/ddpm/fig20_hu8ace829d78d9a17233afe6a958d29f16_189358_c08539eca563fdf6d13ac365cfd50cf6.webp"
               width="760"
               height="261"
               loading="lazy" data-zoomable /></div>
  </div></figure>

因此，实际训练时，如下图所示，对于样本$x_0$，我们首先构造$x_t=\sqrt{\bar{\alpha}_t} x_0+\sqrt{1-\bar{\alpha}_t} \varepsilon$，然后将$x_t$与$t$作为Denoise网络的输入，希望输出的结果与$q\left(x_{t-1} \mid x_t, x_0\right)$的均值
$$\frac{\sqrt{\bar{\alpha}_{t-1}} \beta_t x_0+\sqrt{\alpha_t}\left(1-\bar{\alpha}_{t-1}\right) x_t}{1-\bar{\alpha}_t}\qquad(\star)$$
越接近越好。
















<figure  >
  <div class="d-flex justify-content-center">
    <div class="w-100" ><img alt="" srcset="
               /media/posts/ddpm/fig21_hud1a3113e8657a3e31ed4c25722cba978_414492_65e3b56f739c95eb7c67ea4ea03b47bf.webp 400w,
               /media/posts/ddpm/fig21_hud1a3113e8657a3e31ed4c25722cba978_414492_3dc3a380cc85c19e83d1abef24e000ba.webp 760w,
               /media/posts/ddpm/fig21_hud1a3113e8657a3e31ed4c25722cba978_414492_1200x1200_fit_q75_h2_lanczos_3.webp 1200w"
               src="/media/posts/ddpm/fig21_hud1a3113e8657a3e31ed4c25722cba978_414492_65e3b56f739c95eb7c67ea4ea03b47bf.webp"
               width="760"
               height="259"
               loading="lazy" data-zoomable /></div>
  </div></figure>

注意到$x_t=\sqrt{\bar{\alpha}_t} x_0+\sqrt{1-\bar{\alpha}_t} \varepsilon$，通过反解$x_0$，代入$(\star)$式中得到
$$
\begin{aligned}
&amp;\frac{\sqrt{\bar{\alpha}_{t-1}} \beta_t x_0+\sqrt{\alpha_t}\left(1-\bar{\alpha}_{t-1}\right) x_t}{1-\bar{\alpha}_t}\\
&amp; =\frac{\sqrt{\bar{\alpha}_{t-1}} \beta_t\left(\frac{x_t-\sqrt{1-\bar{\alpha}_t} \varepsilon}{\sqrt{\bar{\alpha}_t}}\right)+\sqrt{\alpha_t}\left(1-\bar{\alpha}_{t-1}\right) x_t}{1-\bar{\alpha}_t} \\
&amp; ={\color{red}\frac{1}{\sqrt{\alpha_t}}\left(x_t-\frac{1-\alpha_t}{\sqrt{1-\bar{\alpha}_t}} \varepsilon\right)}
\end{aligned}
$$
因此，如下图所示，Denoise模式要做的就是预测出$\varepsilon$，因为$\alpha_t$这些参数都是预先设定好的，跟网络无关。
















<figure  >
  <div class="d-flex justify-content-center">
    <div class="w-100" ><img alt="" srcset="
               /media/posts/ddpm/fig22_hua43fd0105d76fafc2612dc6af5cc8746_1716234_839a2eee19b2b4dce83f2bb5b517f0be.webp 400w,
               /media/posts/ddpm/fig22_hua43fd0105d76fafc2612dc6af5cc8746_1716234_958e01c67abcdea11a34be303a87a9bb.webp 760w,
               /media/posts/ddpm/fig22_hua43fd0105d76fafc2612dc6af5cc8746_1716234_1200x1200_fit_q75_h2_lanczos_3.webp 1200w"
               src="/media/posts/ddpm/fig22_hua43fd0105d76fafc2612dc6af5cc8746_1716234_839a2eee19b2b4dce83f2bb5b517f0be.webp"
               width="760"
               height="414"
               loading="lazy" data-zoomable /></div>
  </div></figure>

同时，我们也可以发现这个式子与DDPM论文中Sampling那个式子是一样的。</p>
<hr>
<p>最后，我们注意到算法二中Sampling的公式
$$
\mathbf{x}_{t-1}=\frac{1}{\sqrt{\alpha_t}}\left(\mathbf{x}_t-\frac{1-\alpha_t}{\sqrt{1-\bar{\alpha}_t}} \boldsymbol{\epsilon}_\theta\left(\mathbf{x}_t, t\right)\right)+{\color{red}{\sigma_t \mathbf{z}}}
$$
仍然在每一步引入了随机项，为什么不直接取均值呢？这个问题其实跟文本生成模型中引入随机性是一样的道理，如下图所示，在文本生成模型中，如果每次都取概率最大的，那么生成的文字很有可能出现重复进而导致较差的效果：
















<figure  >
  <div class="d-flex justify-content-center">
    <div class="w-100" ><img alt="" srcset="
               /media/posts/ddpm/fig23_hua8c1ba845f0f004c323ccee4fe3e673a_495081_287831ba93e26c60ae473c59818adf0f.webp 400w,
               /media/posts/ddpm/fig23_hua8c1ba845f0f004c323ccee4fe3e673a_495081_c581bf530ab1e3d52d3f8685e06e2a30.webp 760w,
               /media/posts/ddpm/fig23_hua8c1ba845f0f004c323ccee4fe3e673a_495081_1200x1200_fit_q75_h2_lanczos_3.webp 1200w"
               src="/media/posts/ddpm/fig23_hua8c1ba845f0f004c323ccee4fe3e673a_495081_287831ba93e26c60ae473c59818adf0f.webp"
               width="760"
               height="274"
               loading="lazy" data-zoomable /></div>
  </div></figure>

下图的结果也确实验证了这个情况
















<figure  >
  <div class="d-flex justify-content-center">
    <div class="w-100" ><img alt="" srcset="
               /media/posts/ddpm/fig24_hue9f0741a07e9627ab62f60e2b9ad96fd_248159_ecc3bcd8bf472c91ab1dcca873da91c8.webp 400w,
               /media/posts/ddpm/fig24_hue9f0741a07e9627ab62f60e2b9ad96fd_248159_a5e693a5e8d6613bb62a6291e24018bc.webp 760w,
               /media/posts/ddpm/fig24_hue9f0741a07e9627ab62f60e2b9ad96fd_248159_1200x1200_fit_q75_h2_lanczos_3.webp 1200w"
               src="/media/posts/ddpm/fig24_hue9f0741a07e9627ab62f60e2b9ad96fd_248159_ecc3bcd8bf472c91ab1dcca873da91c8.webp"
               width="760"
               height="232"
               loading="lazy" data-zoomable /></div>
  </div></figure>
</p>
<hr>
<h3 id="3-基于分数的生成模型score-based-generative-models">3 、基于分数的生成模型（Score-based generative models）</h3>
<blockquote>
<p>主要参考：<a href="https://zhuanlan.zhihu.com/p/597490389" target="_blank" rel="noopener">知乎：@CW不要無聊的風格</a></p>
</blockquote>
<p>















<figure  >
  <div class="d-flex justify-content-center">
    <div class="w-100" ><img alt="" srcset="
               /media/posts/ddpm/fig26_hu501c0461d78f3f7a70fc142ea2efff13_234389_3acabb8e171af549273a827a36531b73.webp 400w,
               /media/posts/ddpm/fig26_hu501c0461d78f3f7a70fc142ea2efff13_234389_a8edb9d058d3254a6f6efa060a2eaadc.webp 760w,
               /media/posts/ddpm/fig26_hu501c0461d78f3f7a70fc142ea2efff13_234389_1200x1200_fit_q75_h2_lanczos_3.webp 1200w"
               src="/media/posts/ddpm/fig26_hu501c0461d78f3f7a70fc142ea2efff13_234389_3acabb8e171af549273a827a36531b73.webp"
               width="760"
               height="365"
               loading="lazy" data-zoomable /></div>
  </div></figure>

我们希望生成模型能表示概率分布，从而能够通过其实现采样生成。至于如何表示，不同的模型有不同的方法，但它们大致都可被归纳为两种范式，分别是：对数据的<strong>采样过程</strong>建模和对<strong>概率密度</strong>进行建模。前者不纠结于数据分布的概率密度，而是通过其它方法达到表示概率分布的目的，因此也被称为隐式(implicit)生成模型，例如GAN；而后者则直接让模型去估计概率密度，不绕圈子，于是被称为显式(explicit)生成模型，例如VAE 、DDPM。而基于分数的生成模型和这两类都不太一样，该领域的代表作为<a href="https://proceedings.neurips.cc/paper_files/paper/2019/file/3001ef257407d5a371a96dcd947c7d93-Paper.pdf" target="_blank" rel="noopener">Generative Modeling by Estimating Gradients of the Data Distribution</a>这篇文章。</p>
<h4 id="31-朗之万动力学采样">3.1 朗之万动力学采样</h4>
<p>朗之万动力学(Langevin dynamics)是物理学中对分子系统进行统计建模(布朗运动)的工具</p>
<p>















<figure  >
  <div class="d-flex justify-content-center">
    <div class="w-100" ><img alt=""
           src="/media/posts/ddpm/video1.gif"
           loading="lazy" data-zoomable /></div>
  </div></figure>
</p>
<p>上图模拟了花粉(黄色)收到大量水分子的撞击进行随机的布朗运动的情形。朗之万方程可化简为</p>
<p>$${X_{t+dt}} = X_t-\frac{dt}{\gamma} \frac{\partial E}{\partial X}+\frac{dt}{\gamma} \epsilon,$$
这里的$-\frac{dt}{\gamma} \frac{\partial E}{\partial X}$表示能量减小得最快的方向，因此该方程刻画了粒子会往能量减小的最快的方向移动。而在2011年的文章<a href="https://citeseerx.ist.psu.edu/document?repid=rep1&amp;type=pdf&amp;doi=56f89ce43d7e386bface3cba63e674fe748703fc" target="_blank" rel="noopener">Bayesian learning via stochastic gradient Langevin dynamics</a>中，提出了随机梯度朗之万动力学，而基于分数的生成模型的一些理论保证就来源于该文章。那我们应该怎么使用这个动力学方程从一个分布$p(x)$进行采样呢？答案是下面这个公式：</p>
<p>$$
\tilde{\mathbf{x}}_t=\tilde{\mathbf{x}}_{t-1}+\frac{\epsilon}{2} \nabla_{\mathbf{x}} \log p\left(\tilde{\mathbf{x}}_{t-1}\right)+\sqrt{\epsilon} \mathbf{z}_t
$$
具体而言，我们可以从任意的先验分布$\pi(\mathbf{x})$中抽样一个初始样本$\tilde{\mathbf{x}}_0$，然后按照上式更新即可。这里的$\mathbf{z}_t\sim \mathcal{N}(0,I)$。因此我们可以发现这样的采样过程只会涉及到对数似然的梯度$\nabla_{\mathbf{x}} \log p\left(\tilde{\mathbf{x}}_{t-1}\right)$，只要我们能准确地近似这个梯度，那么我们就可以随意采样，随意生成高质量的图片。这个梯度被称之为“分数”（score），这也是该类方法的名字由来。理论上, 在一定约束条件下, 并且当 $\epsilon \rightarrow 0, T \rightarrow \infty$ 时, 最终生成的样本 $x_T$ 将会服从原数据分布 $p_{\text {data }}(x)$ 。
















<figure  >
  <div class="d-flex justify-content-center">
    <div class="w-100" ><img alt="" srcset="
               /media/posts/ddpm/fig27_hufc1161ab624693f27e78c03c5b6f41a0_80090_9464ea5c7c000a5927a667edeeb8bc1b.webp 400w,
               /media/posts/ddpm/fig27_hufc1161ab624693f27e78c03c5b6f41a0_80090_e8079b7e03987991a7faf5e1ba12dade.webp 760w,
               /media/posts/ddpm/fig27_hufc1161ab624693f27e78c03c5b6f41a0_80090_1200x1200_fit_q75_h2_lanczos_3.webp 1200w"
               src="/media/posts/ddpm/fig27_hufc1161ab624693f27e78c03c5b6f41a0_80090_9464ea5c7c000a5927a667edeeb8bc1b.webp"
               width="609"
               height="194"
               loading="lazy" data-zoomable /></div>
  </div></figure>
</p>
<p>因此，现在的问题转化为如何利用神经网络得到$\mathbf{s}_\theta(\mathbf{x})$，使其约接近$\nabla_{\mathbf{x}} \log p\left(\tilde{\mathbf{x}}_{t-1}\right)$越好</p>
<p>















<figure  >
  <div class="d-flex justify-content-center">
    <div class="w-100" ><img alt=""
           src="/media/posts/ddpm/video2.gif"
           loading="lazy" data-zoomable /></div>
  </div></figure>
</p>
<h4 id="32-分数模型理论">3.2 分数模型理论</h4>
<p>根据前面的介绍，我们可以得到分数模型的训练目标
$$
\frac{1}{2} E_{p_{\text {data }}}\left[\left\|s_\theta(x)-\frac{\partial \log \left(p_{\text {data }}(x)\right)}{\partial x}\right\|_2^2\right]\qquad (1)
$$
其中, $\theta$代表网络参数，$s_\theta(x)$是网络估计的分数，其减去的右边那项代表真实的分数，$E_{P_{d a t a}}$表示在整体数据中求期望。但是这显示是无法计算的，因为我们并不知道分布$p_{\text {data }}$，但是我们可以通过<strong>score matching(分数匹配)</strong> 的方法，可以让我们在不了解概率密度的情况下也可以成功训练出模型来估计分数，即上述目标函数等价于</p>
<p>$$
\mathbb{E}_{p_{\text {data }}(\mathbf{x})}\left[\operatorname{tr}\left(\nabla_{\mathbf{x}} \mathbf{s}_{\boldsymbol{\theta}}(\mathbf{x})\right)+\frac{1}{2}\left\|\mathbf{s}_{\boldsymbol{\theta}}(\mathbf{x})\right\|_2^2\right]
$$
这里的$\nabla_{\mathbf{x}} \mathbf{s}_{\boldsymbol{\theta}}(\mathbf{x})$其实就是 Jacobian矩阵，但是注意到当$\mathbf{x}$维度很高的时候，$\nabla_{\mathbf{x}} \mathbf{s}_{\boldsymbol{\theta}}(\mathbf{x})$的反向传播是非常麻烦的，因此论文中提到了两种方法来解决这个问题，分别是：sliced score matching和denoising score matching</p>
<ul>
<li><strong>Sliced Score Matching(切片分数匹配)</strong></li>
</ul>
<p>既然这个矩阵的trace很难计算，那我们可以尝试去估计它，利用<a href="https://zhuanlan.zhihu.com/p/597490389" target="_blank" rel="noopener">Hutchinson trace estimator</a>，对于任意一个矩阵$A$，我们有
$$
\begin{aligned}
\operatorname{tr}(A)&amp;=\operatorname{tr}\left(A \mathbb{E}\left[v v^T\right]\right)=\operatorname{tr}\left(\mathbb{E}\left[A v v^T\right]\right)=\mathbb{E}\left[\operatorname{tr}\left(A v v^T\right)\right]\\
&amp;=\mathbb{E}\left[\operatorname{tr}\left(v^T A v\right)\right]=\mathbb{E}\left[v^T A v\right]
\end{aligned}
$$
其中$v\sim (0,I)$，因此我们可以得到</p>
<p>$$\operatorname{tr}\left(\frac{\partial s_\theta(x)}{\partial x}\right)=\mathbb{E}_{p_v}\left[v^T \frac{\partial s_\theta(x)}{\partial x} v\right]=\mathbb{E}_{p_v}\left[\frac{\partial\left(v^T s_{\theta(x)}\right)}{\partial x} v\right]$$
这样就很大程度上简化了梯度的计算，训练的目标函数也变为：
$$
E_{p_v} E_{p_{\text {data }}}\left[\frac{\partial\left(v^T s_\theta(x)\right)}{\partial x} v+\frac{1}{2}\left\|s_\theta(x)\right\|_2^2\right]
$$</p>
<ul>
<li><strong>Denoising Score Matching(去噪分数匹配)</strong></li>
</ul>
<p>这个方法是原文默认的方法，具体而言，就是在原分布上加噪声，然后利用$(1)$式来训练。记训练样本为 $x$, 加噪后的数据为 $\tilde{x}$, 预定义的分布为 $q_\sigma(\tilde{x} \mid x) \sim N\left(\tilde{x} ; x, \sigma^2 I\right)$, 方差 $\sigma^2$ 预先定义好。加噪后的数据分布表示为: $q_\sigma(\tilde{x})=\int q_\sigma(\tilde{x} \mid x) p_{\text {data }}(x) d x$。</p>
<p>$$
\begin{aligned}
&amp;\mathbb{E}_{q_\sigma(\tilde{x})}\left[\left\|s_\theta(\tilde{x})-\frac{\partial \log \left(q_\sigma(\bar{x})\right)}{\partial \tilde{x}}\right\|^2\right]\\
=&amp;\mathbb{E}_{q_\sigma(\tilde{x} \mid x) p_{\text {data }}(x)}\left[\left\|s_\theta(\tilde{x})-\frac{\partial \log \left(q_\sigma(\tilde{x} \mid x)\right)}{\partial \tilde{x}}\right\|^2\right]+C
\end{aligned}
$$
其中$C$为一个与模型参数$\theta$不相关的常数项。</p>
<p>等号左边是加噪后最直接的分数匹配形式（<strong>显式的分数匹配</strong>(Explicit Score Matching)），而等号右边则是实际使用的<strong>去噪分数匹配形式</strong>(DSM)，ESM与DSM的等价性证明见（<a href="https://zhuanlan.zhihu.com/p/597490389" target="_blank" rel="noopener">知乎</a>）。于是, 训练目标就转化为:
$$
\frac{1}{2} E_{q_\sigma(\tilde{x} \mid x) p_{\text {data }}(x)}\left[\left\|s_\theta(\tilde{x})-\frac{\partial \log \left(q_\sigma(\tilde{x} \mid x)\right)}{\partial \tilde{x}}\right\|_2^2\right]
$$
在训练模型时，我们只需要将加噪后的样本$\tilde{x}$喂给模型即可计算估计分数，但是另外, 这个分数是对应噪声数据分布$q_\sigma(\tilde{x})$的, 而非原始数据分布$p_{\text {data }}(x)$，因此我们需要让$q_\sigma(\tilde{x})$尽可能与$p_{\text {data }}(x)$ 接近, 这就要求预定义的$\sigma$ 要足够小。否则, 如果对原始数据扰动过大，模型训练完后生成的样本就会严重偏离原数据分布。</p>
<h4 id="33-分数模型面临的问题">3.3 分数模型面临的问题</h4>
<ul>
<li><strong>训练时损失不收敛</strong></li>
</ul>
<p>基于sliced score matching方式下训练的loss
















<figure  >
  <div class="d-flex justify-content-center">
    <div class="w-100" ><img alt="" srcset="
               /media/posts/ddpm/fig28_hu7286c9ac5bf0aa19bace7cf1b394c7e5_144845_b10ce21489b9384e930175f8ac0265d5.webp 400w,
               /media/posts/ddpm/fig28_hu7286c9ac5bf0aa19bace7cf1b394c7e5_144845_42fc343f9b0fa297dbac8b5cdd200420.webp 760w,
               /media/posts/ddpm/fig28_hu7286c9ac5bf0aa19bace7cf1b394c7e5_144845_1200x1200_fit_q75_h2_lanczos_3.webp 1200w"
               src="/media/posts/ddpm/fig28_hu7286c9ac5bf0aa19bace7cf1b394c7e5_144845_b10ce21489b9384e930175f8ac0265d5.webp"
               width="760"
               height="519"
               loading="lazy" data-zoomable /></div>
  </div></figure>

不收敛的原因可以通过“流形假设”(mainfold hypotheis)来解释。流行假设认为，生活中的真实数据大部分都倾向于分布在低维空间中，而我们的编码空间(通过神经网络等一系列方法)的维度可能很广泛，但是数据经过编码后在许多维度上都存在冗余，实际上用一部分维度就足以表示它，说明实质上它仅分布在整个编码空间中的一部分(低维流形)，并没有“占满”整个编码空间。当我们的数据仅分布在编码空间的低维流形时，分数就会出现“没有定义” (undefined) 的情况。另外，score matching 的训练目标是基于数据“占满”了整个编码空间这个前提下而推出来的。当数据仅分布在低维流形中时，score matching 的方法就不适用了。</p>
<ul>
<li>
<p><strong>分数估计不准</strong>
















<figure  >
  <div class="d-flex justify-content-center">
    <div class="w-100" ><img alt="" srcset="
               /media/posts/ddpm/fig29_hu09258e34174ea97a35a1ef313b2075b4_387253_eaa0179f17567a3dbd680e44f5d3d0ab.webp 400w,
               /media/posts/ddpm/fig29_hu09258e34174ea97a35a1ef313b2075b4_387253_fe06a8c5e7df64051cc290ac4a700077.webp 760w,
               /media/posts/ddpm/fig29_hu09258e34174ea97a35a1ef313b2075b4_387253_1200x1200_fit_q75_h2_lanczos_3.webp 1200w"
               src="/media/posts/ddpm/fig29_hu09258e34174ea97a35a1ef313b2075b4_387253_eaa0179f17567a3dbd680e44f5d3d0ab.webp"
               width="760"
               height="384"
               loading="lazy" data-zoomable /></div>
  </div></figure>

如上图所示，颜色深浅代表数据概率密度的大小(越深越大，对应的样本越可能出现)，箭头代表分数。可以看到，右图的箭头(也就是模型估计的分数)在颜色深的地方基本和左图的箭头(也就是真实的分数)一致，如矩形框出来的部分所示。而在颜色比较浅的部分，特别是左图和右图对角线那部分，两者的箭头差异就比较大，代表模型估计的分数不准确。</p>
</li>
<li>
<p><strong>生成结果偏差大</strong></p>
</li>
</ul>
<p>原文中，作者发现训练后的模型生成效果不佳，采样生成出来的样本不太符合原数据分布。作者发现当数据分布是由多个分布按一定比例混合而成时，在朗之万动力学采样的玩法下，即使用真实的分数，采样生成出来的结果也可能<strong>不能反应出各个分布之间的比例关系</strong>，如下图所示：
















<figure  >
  <div class="d-flex justify-content-center">
    <div class="w-100" ><img alt="" srcset="
               /media/posts/ddpm/fig30_hu8d7b30ba1bdb4710aadb838d3d066d89_104834_2ef838e509c1aa0c15b3972e273bf501.webp 400w,
               /media/posts/ddpm/fig30_hu8d7b30ba1bdb4710aadb838d3d066d89_104834_f8685c455fbc8e513429cb053651d9fc.webp 760w,
               /media/posts/ddpm/fig30_hu8d7b30ba1bdb4710aadb838d3d066d89_104834_1200x1200_fit_q75_h2_lanczos_3.webp 1200w"
               src="/media/posts/ddpm/fig30_hu8d7b30ba1bdb4710aadb838d3d066d89_104834_2ef838e509c1aa0c15b3972e273bf501.webp"
               width="760"
               height="396"
               loading="lazy" data-zoomable /></div>
  </div></figure>

之所以会出现这种情况，猜测是因为采样时会丢失比例关系，举个简单的粒子，考虑两种分布为$p_1(x)$和$p_2(x)$, 分别以比例$\pi$和$1-\pi$混合而成, 于是整体的数据分布表示为：
$$
p_{\text {data }}(x)=\pi p_1(x)+(1-\pi) p_2(x)
$$</p>
<p>对于整体数据分布对应的分数, 如果我们分别来看其中两个分布对应的分数, 就会发现其实和它们的混合比例不相关:
$$
\begin{aligned}
\frac{\partial \log \left(p_{\text {data }}(x)\right)}{\partial x}=&amp; \frac{\partial \log \left(\pi p_1(x)\right)}{\partial x}+\frac{\partial \log \left((1-\pi) p_2(x)\right)}{\partial x}\\
=&amp;\frac{\partial \log \left(p_1(x)\right)}{\partial x} +\frac{\partial \log \left(p_2(x)\right)}{\partial x}
\end{aligned}
$$</p>
<p>这样就就没有关于$\pi$的信息了。原文说到面对这种混合分布的情况，从理论上来说，朗之万动力学采样是可以生成与原分布相似的结果的，但可能需要很小的步长(step size)以及非常大的步数(steps)才能做到。</p>
<h4 id="34-利用ncsn解决三个问题">3.4 利用NCSN解决三个问题</h4>
<p>NCSN是Noise Conditional Score Networks的缩写，作者用NCSN 解决了上一节中提到的三个问题。</p>
<ul>
<li><strong>解决Loss不收敛</strong></li>
</ul>
<p>NCSN利用了高斯噪声去扰动数据（仅仅需要一个非常小的扰动），而高斯噪声是分布在整个编码空间的，因此，扰动后的数据能够有机会出现在整个编码空间的任意部分，从而避免了分数(score)没有定义(undefined)的情况，同时使得分数匹配公式适用，这就破解了“loss 不收敛”的困局。</p>
<ul>
<li><strong>解决分数估计不准</strong></li>
</ul>
<p>















<figure  >
  <div class="d-flex justify-content-center">
    <div class="w-100" ><img alt="" srcset="
               /media/posts/ddpm/fig32_hu0fc04be8cd1fa824eba1dce915f5ad53_105719_1fcf05af3f397b7c8ccb988e62429f59.webp 400w,
               /media/posts/ddpm/fig32_hu0fc04be8cd1fa824eba1dce915f5ad53_105719_288206c3af785323e934def09898f52d.webp 760w,
               /media/posts/ddpm/fig32_hu0fc04be8cd1fa824eba1dce915f5ad53_105719_1200x1200_fit_q75_h2_lanczos_3.webp 1200w"
               src="/media/posts/ddpm/fig32_hu0fc04be8cd1fa824eba1dce915f5ad53_105719_1fcf05af3f397b7c8ccb988e62429f59.webp"
               width="601"
               height="198"
               loading="lazy" data-zoomable /></div>
  </div></figure>

















<figure  >
  <div class="d-flex justify-content-center">
    <div class="w-100" ><img alt="" srcset="
               /media/posts/ddpm/fig31_hub1b5b87f3c8cf7064650129d5b3a546c_125078_f803fdab9c10b04744917cb14f14629f.webp 400w,
               /media/posts/ddpm/fig31_hub1b5b87f3c8cf7064650129d5b3a546c_125078_3bbbf4dc1e5300b8ed559646917705e5.webp 760w,
               /media/posts/ddpm/fig31_hub1b5b87f3c8cf7064650129d5b3a546c_125078_1200x1200_fit_q75_h2_lanczos_3.webp 1200w"
               src="/media/posts/ddpm/fig31_hub1b5b87f3c8cf7064650129d5b3a546c_125078_f803fdab9c10b04744917cb14f14629f.webp"
               width="613"
               height="198"
               loading="lazy" data-zoomable /></div>
  </div></figure>
</p>
<p>通过扰动数据的时候，噪声会有更多机会将原来的数据扩散到低概率密度区域，于是原来的低概率密度区域就能获得更多的监督信号，从而提升了分数估计的准确性，这就能破解了低密度趋于“分数估计不准”的问题。</p>
<ul>
<li><strong>解决生成结果偏差大</strong></li>
</ul>
<p>















<figure  >
  <div class="d-flex justify-content-center">
    <div class="w-100" ><img alt="" srcset="
               /media/posts/ddpm/fig33_hu795e947a51f957dc3b0e2b90fa41ca50_240501_9d1ba9226b8d599fe762049c731c1e77.webp 400w,
               /media/posts/ddpm/fig33_hu795e947a51f957dc3b0e2b90fa41ca50_240501_54d0f1d3b396c50702b1007fcc1724df.webp 760w,
               /media/posts/ddpm/fig33_hu795e947a51f957dc3b0e2b90fa41ca50_240501_1200x1200_fit_q75_h2_lanczos_3.webp 1200w"
               src="/media/posts/ddpm/fig33_hu795e947a51f957dc3b0e2b90fa41ca50_240501_9d1ba9226b8d599fe762049c731c1e77.webp"
               width="760"
               height="256"
               loading="lazy" data-zoomable /></div>
  </div></figure>
</p>
<p>加噪后，原本“稀疏”的低概率密度区域就能够被“填满”，并且，自然地，两个分布中混合比例高的那个分布所占这部分(“填满”后的区域)的比例会更高，因此扰动后的分数将更多地由混合比例高的那个分布的分数“演变”而来。这就是说，分数的方向将更多地指向混合比例高的那个分布。</p>
<h4 id="35-ncsn的技术细节">3.5 NCSN的技术细节</h4>
<ul>
<li><strong>噪声设计原则</strong></li>
</ul>
<p>从前一节可以看出，加噪是该模型的精髓，但是具体应该加多大的噪声呢？直觉上为了让扰动后的分布能够更多地“填充”原来的低概率密度区域，我们应该加一个大的噪声，但是，我们需要用加噪后的分数 $\frac{\partial \log \left(q_\sigma(\tilde{x})\right)}{\partial \tilde{x}}$ 来近似原分布的分数 $\frac{\partial \log \left(p_{\text {data }}(x)\right)}{\partial x}$ 的 $(\tilde{x}, x$ 分别代表加噪后的数据与原数据)。若扰动过大, 抹去了原数据大部分信息, 就会造成近似效果不佳，因此噪声强度小能够获得与原数据分布较为近似的效果, 但是却不能够很好地“填充”低概率密度区域。于是，需要做一个 trade-off 。原文中，作者采用了一个噪声序列 $\left\{\sigma_i\right\}_{i=1}^L$, 并满足: $\frac{\sigma_1}{\sigma_2}=\ldots=\frac{\sigma_{L-1}}{\sigma_L}&gt;1$, 同时 $\sigma_1$ 需要足够大, 以能够充分“填充”低概率密度区域; 而 $\sigma_L$ 得足够小, 以获得对原数据分布良好的近似, 避免过度扰动。</p>
<ul>
<li><strong>训练方法：去噪分数匹配</strong></li>
</ul>
<p>切片分数匹配(sliced score matching)也可以训练NCSN，但计算更多，训练过程会更慢，因此，作者使用去噪分数匹配进行训练，注意到我们的训练目标位</p>
<p>$$
\frac{1}{2} E_{q_\sigma(\tilde{x} \mid x) p_{\text {data }}(x)}\left[\left\|s_\theta(\tilde{x})-\frac{\partial \log \left(q_\sigma(\tilde{x} \mid x)\right)}{\partial \tilde{x}}\right\|_2^2\right]
$$</p>
<p>由于加噪后的样本$\tilde{x}\sim\mathcal{N}(x,\sigma^2 \mathbf{I})$，因此</p>
<p>$$q_\sigma(\tilde{x} \mid x)=\frac{1}{\sqrt{2 \pi \sigma}} e^{-\frac{(\bar{x}-\mathrm{x})^2}{2 \sigma^2}}$$</p>
<p>将其取对数井对 $\tilde{x}$求导, 就可获得其分数的表示形式:</p>
<p>$$
\frac{\partial \log \left(q_\sigma(\bar{x} \mid x)\right)}{\partial \tilde{x}}=-\left(\frac{\bar{x}-x}{\sigma^2}\right)
$$</p>
<p>将以上代入目标函数, 就得到在某个噪声级别 $\sigma$ 对应的损失函数:</p>
<p>$$
l(\theta ; \sigma) \equiv \frac{1}{2} E_{p_{\text {data }}(x)} E_{\tilde{x} \sim N\left(x, \sigma^2 I\right)}\left[\left|s_\theta(\tilde{x}, \sigma)+\frac{\bar{x}-x}{\sigma^2}\right|_2^2\right]
$$</p>
<p>其中 $s_\theta(\tilde{x}, \sigma)$ 代表网络在特定噪声级别 $\sigma$ 下估计的分数。
而 NCSN 使用了多个噪声级别, 于是, 分别对它们的损失加权求和后再求均值, 就得到了联合的损失函数，它表示为:</p>
<p>$$
L\left(\theta ;\left\{\sigma_i\right\}_{i=1}^L\right) \equiv \frac{1}{L} \sum_{i=1}^L \lambda\left(\sigma_i\right) l\left(\theta ; \sigma_i\right)
$$</p>
<p>其中$\lambda\left(\sigma_i\right)&gt;0$代表不同噪声级别的损失的权重，但是应该怎么设置$\lambda\left(\sigma_i\right)$呢？首先需要保证的是加权后所有噪声级别的损失都在同一量级，不受$\sigma_i$ 的大小影响。然后作者 发现网络训练到收玫时, 估计出的分数的量级 $\left\|s_\theta(x, \sigma)\right\|_2$在 $\frac{1}{\sigma}$ 这个水平, 即: $s_\theta(x, \sigma) \asymp \frac{1}{\sigma}$ 。因此作者将 $\lambda(\sigma)$ 设置为 $\sigma^2$。其实，把$\lambda\left(\sigma_i\right)=\sigma_i^2$ 代入$L\left(\theta ;\left\{\sigma_i\right\}_{i=1}^L\right)$会发现:</p>
<p>$$
\begin{aligned}
\lambda\left(\sigma_i\right) l\left(\theta ; \sigma_i\right)&amp;=\sigma_i^2 l\left(\theta ; \sigma_i\right)=\frac{1}{2} E\left[\left\|\sigma_i s_\theta\left(\tilde{x}, \sigma_i\right)+\sigma_i \frac{\tilde{x}-x}{\sigma_i^2}\right\|_2^2\right] \\
&amp; =\frac{1}{2} E\left[\left\|\sigma_i s_\theta\left(\tilde{x}, \sigma_i\right)+\frac{\tilde{x}-x}{\sigma_i}\right\|_2^2\right]\qquad(2)
\end{aligned}
$$</p>
<p>由于 $q_{\sigma_i}(\tilde{x} \mid x) \sim N\left(\tilde{x} ; x, \sigma_i^2 I\right)$, 因此有$\frac{\tilde{x}-x}{\sigma}$ 就是噪声 $\epsilon \sim N\left(0, I^2\right)$,这是与 $\sigma_i$ 无关的量, 即不受后者影响。在这种训练方式下, 只要预先设定好 $\left\{\sigma_i\right\}_{i=1}^L$, 然后在每次迭代时随机选取其中一个噪声级别 $\sigma_i$ , 并采样一个标准高斯噪声 $\epsilon$, 对原始数据样本加噪: $\tilde{x}=x+\sigma_i \epsilon$, 接着将加噪后的样本 $\tilde{x}$ 与对应的噪声级别 $\sigma_i$ 作为网络输入, 待其输出预测的分数 $s_\theta\left(\tilde{x}, \sigma_i\right)$ 后, 就可以使用 $(2)$ 来计算损失了。</p>
<ul>
<li><strong>采样生成：退火朗之万动力学</strong></li>
</ul>
<p>















<figure  >
  <div class="d-flex justify-content-center">
    <div class="w-100" ><img alt="" srcset="
               /media/posts/ddpm/fig34_hucdb9a1a081a360198c3e428ced2ae1de_6576438_295594960ffd360ca5abfbbb54b4b22c.webp 400w,
               /media/posts/ddpm/fig34_hucdb9a1a081a360198c3e428ced2ae1de_6576438_7c1d57688336a816ad460a34f6ac7191.webp 760w,
               /media/posts/ddpm/fig34_hucdb9a1a081a360198c3e428ced2ae1de_6576438_1200x1200_fit_q75_h2_lanczos_3.webp 1200w"
               src="/media/posts/ddpm/fig34_hucdb9a1a081a360198c3e428ced2ae1de_6576438_295594960ffd360ca5abfbbb54b4b22c.webp"
               width="760"
               height="325"
               loading="lazy" data-zoomable /></div>
  </div></figure>
</p>
<p>在训练好模型后，我们需要进行采样生成图片，原文中作者使用的方法为退火朗之万采样法，这种方法实质上是在噪声强度递减的情况下使用朗之万动力学采样，在每个噪声级别下都有一个朗之万动力学采样生成的过程。首先, 初始样本 $\tilde{x}_0$ 从某种固定的先验分布去采样(作者默认采用均匀分布); 然后, 从最大的噪声级别 $\sigma_1$ 开始使用朗之万动力学采样, 直至最小的噪声级别 $\sigma_L$ 。在每个噪声级别进行采样前, 会先设定步长(step size) $\alpha_i$，接着, 在每个噪声级别下, 基于一定的步数 $T$ 去迭代进行朗之万动力学采样。该噪声级别最后一步采样生成的样本会作为下一个噪声级别的初始样本(见上图 $\tilde{x}_0 \leftarrow x_T$); 最后, 待所有噪声级别的朗之万动力学采样过程均完成时, 就得到了最终的生成结果。这里步长设置的动机就是固定 &ldquo;信噪比&rdquo; (signalto-noise) 的量级，即$\frac{\alpha_i s_\theta\left(x, \sigma_i\right)}{2 \sqrt{\alpha_i} z}$ ( $z$ 是随机噪声)。该信噪比的量级为：</p>
<p>$$
E\left|\frac{\alpha_i s_\theta\left(x, \sigma_i\right)}{2 \sqrt{\alpha_i z}}\right|_2^2 \approx E\left[\frac{\alpha_i\left\|s_\theta\left(x, \sigma_i\right)\right\|_2^2}{4 z^2}\right] \asymp \frac{1}{4} E\left[\left\|\sigma_i s_\theta\left(x, \sigma_i\right)\right\|_2^2\right]
$$</p>
<p>由于$s_\theta\left(x, \sigma_i\right) \asymp \frac{1}{\sigma_i}$, 于是这里就有 $\sigma_i s_\theta\left(x, \sigma_i\right) \asymp 1$ 。因此，我们得到 $\frac{1}{4} E\left[\left|\sigma_i s_\theta\left(x, \sigma_i\right)\right|_2^2\right] \asymp \frac{1}{4}$ 。这就说明, 在 $\alpha_i \asymp \sigma_i^2$ 的设置下, 信噪比会固定在常量级, 与噪声级别 $\sigma_i$ 无关。</p>
<h4 id="36-ddpm和ncsn在sde下的统一">3.6 DDPM和NCSN在SDE下的统一</h4>
<blockquote>
<p>主要参考<a href="https://zhuanlan.zhihu.com/p/662786209" target="_blank" rel="noopener">知乎：@不许打针</a></p>
</blockquote>
<p>宋飏大佬在 2021 年的ICLR的 best paper: <a href="https://arxiv.org/abs/2011.13456" target="_blank" rel="noopener">Score-Based Generative Modeling through Stochastic Differential Equations</a>中从 SDE（Stochastic Differential Equations）的角度说明了 NCSN 与 DDPM 在 SDE 的角度是一致的。</p>
<ul>
<li><strong>随机微分过程</strong></li>
</ul>
<p>许多随机过程（特别是扩散过程）都是随机微分方程 (SDE) 的解。一般来说, SDE具有以下形式:</p>
<p>$$
\mathrm{d} \boldsymbol{x}=f(\boldsymbol{x}, t) \mathrm{d} t+g(t) \mathrm{d} \boldsymbol{w} \Longleftrightarrow \boldsymbol{x}_{t+\Delta t}=\boldsymbol{x}_t+\underbrace{\boldsymbol{f}_t\left(\boldsymbol{x}_t\right) \Delta t}_{\text {确定部分 }}+\underbrace{g_t \sqrt{\Delta t} \boldsymbol{\varepsilon}}_{\text {随机部分 }}, \quad \boldsymbol{\varepsilon} \sim \mathcal{N}(\mathbf{0}, \boldsymbol{I})
$$</p>
<p>其中 $f(\cdot)$ 被称为<strong>漂移系数 (drift coefficient)</strong>, $g(t)$ 被称为<strong>扩散系数 (diffusion coefficient)</strong>, $\boldsymbol{w}$ 是一个标准的布朗运动, $\mathrm{d} w$ 就可以被看成是一个白噪声。这个随机微分方程的解就是一组连续的随机变量 ${\boldsymbol{x}(t)}_{t \in[0, T]}$ 。</p>
<p>同时，任何SDE都有相应的反向SDE，其闭合形式由下式给出：</p>
<p>$$
d \boldsymbol{x}=\left[\boldsymbol{f}_t(\boldsymbol{x})-g_t^2 \nabla_{\boldsymbol{x}} \log p_t(\boldsymbol{x})\right] d t+g_t d \boldsymbol{w}
$$</p>
<p>因此，DDPM与NSCN中加噪和去噪的过程不就可以看出正向SDE与逆向SDE？</p>
<p>















<figure  >
  <div class="d-flex justify-content-center">
    <div class="w-100" ><img alt="" srcset="
               /media/posts/ddpm/fig35_hu0d963069b4bf10aaf1005687a845965a_243433_2e2983bfa1ffd94e153b75c2a68516ca.webp 400w,
               /media/posts/ddpm/fig35_hu0d963069b4bf10aaf1005687a845965a_243433_e4be07b8e471170364e700457e5b99c8.webp 760w,
               /media/posts/ddpm/fig35_hu0d963069b4bf10aaf1005687a845965a_243433_1200x1200_fit_q75_h2_lanczos_3.webp 1200w"
               src="/media/posts/ddpm/fig35_hu0d963069b4bf10aaf1005687a845965a_243433_2e2983bfa1ffd94e153b75c2a68516ca.webp"
               width="720"
               height="311"
               loading="lazy" data-zoomable /></div>
  </div></figure>
</p>
<p>对于 DDPM，前向加噪过程为
$$
x_{t+1}=\sqrt{1-\beta_{t+1}} x_t+\sqrt{\beta_{t+1}} \varepsilon
$$</p>
<p>当 $x \rightarrow 0,(1-x)^\alpha \approx 1-\alpha x$, 那么
$$
\begin{aligned}
x_{t+\Delta t} &amp; =  \sqrt{1-\beta(t+\Delta t) \Delta t} x_t+\sqrt{\beta(t+\Delta t) \Delta t \varepsilon} \\
&amp; \approx\left(1-\frac{1}{2} \beta(t+\Delta t) \Delta t\right) x_t+\sqrt{\beta(t+\Delta t)} \sqrt{\Delta t} \varepsilon \\
&amp; \approx\left(1-\frac{1}{2} \beta(t) \Delta t\right) x_t+\sqrt{\beta(t)} \sqrt{\Delta t \varepsilon}
\end{aligned}
$$</p>
<p>对比SDE形式, 得出
$$
f\left(x_t, t\right)=-\frac{1}{2} \beta(t) x_t ;\qquad g(t)=\sqrt{\beta(t)}
$$</p>
<p>而对于NCSN，前向加噪过程为
$$
x_{t+\Delta t}=x_t+\sqrt{\sigma_{t+\Delta t}^2-\sigma_t^2} \varepsilon
$$</p>
<p>那么
$$
\begin{aligned}
x_{t+\Delta t} &amp; =x_t+\sqrt{\sigma_{t+\Delta t}^2-\sigma_t^2} \varepsilon \\
&amp; =x_t+\sqrt{\frac{\sigma_{t+\Delta t}^2-\sigma_t^2}{\Delta t}} \sqrt{\Delta t} \varepsilon \\
&amp; =x_t+\sqrt{\frac{\Delta \sigma_t^2}{\Delta t} \sqrt{\Delta t} \varepsilon}
\end{aligned}
$$</p>
<p>对比SDE形式, 得出
$$
f\left(x_t, t\right)=0 ;\qquad g(t)=\frac{d}{d t} \sigma_t^2
$$</p>
<p>因此，从上面推导可以看出NCSN和DDPM其实只是SDE框架下不同的$f$和$g$。同时，注意到：
对于NCSN我们有
$$
\frac{x_t}{\sqrt{1+\sigma_t^2}}=\frac{x_0}{\sqrt{1+\sigma_t^2}}+\frac{\sigma_t}{\sqrt{1+\sigma_t^2}} \varepsilon
$$</p>
<p>令
$$
\mathrm{x}_t=\frac{x_t}{\sqrt{1+\sigma_t^2}} ; \sqrt{\bar{\alpha}_t}=\frac{1}{\sqrt{1+\sigma_t^2}}
$$</p>
<p>可得
$$
\mathrm{x}_t=\sqrt{\bar{\alpha}_t} \mathrm{x}_0+\sqrt{1-\bar{\alpha}_t} \varepsilon
$$</p>
<p>可以看出这跟DDPM的加噪过程是相同的。最后，在DDPM的前向过程中, 可以表示为
$$
\left.\boldsymbol{x}_t \sim q\left(\boldsymbol{x}_t \mid \boldsymbol{x}_0\right)=\mathcal{N}\left(\boldsymbol{x}_t ; \sqrt{\bar{\alpha}_t} \boldsymbol{x}_0,\left(1-\bar{\alpha}_t\right) \mathbf{I}\right)\right)
$$</p>
<p>对于一个高斯变量 $z \sim \mathcal{N}\left(z ; \mu_z, \Sigma_z\right)$, 有如下结论:
$$
\mu_z=z+\Sigma_z \nabla \log p(z)
$$</p>
<p>两式带入一下可得
$$
\sqrt{\bar{\alpha}_t} \boldsymbol{x}_0=\boldsymbol{x}_t+\left(1-\bar{\alpha}_t\right) \nabla \log p\left(\boldsymbol{x}_t\right)
$$
$\boldsymbol{x}_t=\sqrt{\bar{\alpha}_t} \boldsymbol{x}_0+\sqrt{1-\bar{\alpha}_t} \varepsilon_t$, 因此
$$
\begin{aligned}
\boldsymbol{x}_0 &amp; =\frac{\boldsymbol{x}_t+\left(1-\bar{\alpha}_t\right) \nabla \log p\left(\boldsymbol{x}_t\right)}{\sqrt{\bar{\alpha}_t}}=\frac{\boldsymbol{x}_t-\sqrt{1-\bar{\alpha}_t} \varepsilon_t}{\sqrt{\bar{\alpha}_t}} \\
&amp; \Rightarrow \nabla \log p\left(\boldsymbol{x}_t\right)=-\frac{\boldsymbol{\varepsilon}_t}{\sqrt{1-\bar{\alpha}_t}}
\end{aligned}
$$</p>
<p>因此DDPM去噪过程中预测的是噪声 $\varepsilon_t$, 而噪声正好就是分数的线性关系且方向相反。去噪的过程也就是朝分数方向移动的过程。</p>
<hr>
<h3 id="参考文献">参考文献</h3>
<ul>
<li><a href="https://zhuanlan.zhihu.com/p/662786209" target="_blank" rel="noopener">https://zhuanlan.zhihu.com/p/662786209</a></li>
<li><a href="https://yinglinzheng.github.io/diffusion-model-tutorial/" target="_blank" rel="noopener">https://yinglinzheng.github.io/diffusion-model-tutorial/</a></li>
<li><a href="https://zhuanlan.zhihu.com/p/658549707" target="_blank" rel="noopener">https://zhuanlan.zhihu.com/p/658549707</a></li>
<li><a href="https://kexue.fm/archives/9119#%E8%AF%A5%E6%80%8E%E4%B9%88%E6%8B%86" target="_blank" rel="noopener">https://kexue.fm/archives/9119#%E8%AF%A5%E6%80%8E%E4%B9%88%E6%8B%86</a></li>
<li><a href="https://zhuanlan.zhihu.com/p/651528231" target="_blank" rel="noopener">https://zhuanlan.zhihu.com/p/651528231</a></li>
<li><a href="https://zhuanlan.zhihu.com/p/595866176" target="_blank" rel="noopener">https://zhuanlan.zhihu.com/p/595866176</a></li>
<li>Ho, J., Jain, A., &amp; Abbeel, P. (2020). <a href="https://proceedings.neurips.cc/paper/2020/file/4c5bcfec8584af0d967f1ab10179ca4b-Paper.pdf" target="_blank" rel="noopener">Denoising diffusion probabilistic models</a>. Advances in neural information processing systems, 33, 6840-6851.</li>
<li>Song, Y., &amp; Ermon, S. (2019). <a href="https://proceedings.neurips.cc/paper_files/paper/2019/file/3001ef257407d5a371a96dcd947c7d93-Paper.pdf" target="_blank" rel="noopener">Generative modeling by estimating gradients of the data distribution</a>. Advances in neural information processing systems, 32.</li>
<li>Song, Y., Sohl-Dickstein, J., Kingma, D. P., Kumar, A., Ermon, S., &amp; Poole, B. (2020). <a href="https://arxiv.org/pdf/2011.13456" target="_blank" rel="noopener">Score-based generative modeling through stochastic differential equations</a>. arXiv preprint arXiv:2011.13456.</li>
<li>Welling, M., &amp; Teh, Y. W. (2011). <a href="https://citeseerx.ist.psu.edu/document?repid=rep1&amp;type=pdf&amp;doi=56f89ce43d7e386bface3cba63e674fe748703fc" target="_blank" rel="noopener">Bayesian learning via stochastic gradient Langevin dynamics</a>. In Proceedings of the 28th international conference on machine learning (ICML-11) (pp. 681-688).</li>
<li>Luo, C. (2022). <a href="https://arxiv.org/pdf/2208.11970" target="_blank" rel="noopener">Understanding diffusion models: A unified perspective.</a> arXiv preprint arXiv:2208.11970.</li>
</ul>

    </div>

    





<div class="article-tags">
  
  <a class="badge badge-light" href="/tag/ddpm/">DDPM</a>
  
  <a class="badge badge-light" href="/tag/diffusion-model/">Diffusion Model</a>
  
</div>



<div class="share-box">
  <ul class="share">
    
      
      
      
        
      
      
      
      
      
      
      
      <li>
        <a href="https://twitter.com/intent/tweet?url=https%3A%2F%2Fikerlz.github.io%2Fpost%2Fddpm%2F&amp;text=%E6%89%A9%E6%95%A3%E6%A8%A1%E5%9E%8B%EF%BC%88Diffusion&#43;Model%EF%BC%89" target="_blank" rel="noopener" class="share-btn-twitter" aria-label="twitter">
          <i class="fab fa-twitter"></i>
        </a>
      </li>
    
      
      
      
        
      
      
      
      
      
      
      
      <li>
        <a href="https://www.facebook.com/sharer.php?u=https%3A%2F%2Fikerlz.github.io%2Fpost%2Fddpm%2F&amp;t=%E6%89%A9%E6%95%A3%E6%A8%A1%E5%9E%8B%EF%BC%88Diffusion&#43;Model%EF%BC%89" target="_blank" rel="noopener" class="share-btn-facebook" aria-label="facebook">
          <i class="fab fa-facebook"></i>
        </a>
      </li>
    
      
      
      
        
      
      
      
      
      
      
      
        
      
      <li>
        <a href="mailto:?subject=%E6%89%A9%E6%95%A3%E6%A8%A1%E5%9E%8B%EF%BC%88Diffusion%20Model%EF%BC%89&amp;body=https%3A%2F%2Fikerlz.github.io%2Fpost%2Fddpm%2F" target="_blank" rel="noopener" class="share-btn-email" aria-label="envelope">
          <i class="fas fa-envelope"></i>
        </a>
      </li>
    
      
      
      
        
      
      
      
      
      
      
      
      <li>
        <a href="https://www.linkedin.com/shareArticle?url=https%3A%2F%2Fikerlz.github.io%2Fpost%2Fddpm%2F&amp;title=%E6%89%A9%E6%95%A3%E6%A8%A1%E5%9E%8B%EF%BC%88Diffusion&#43;Model%EF%BC%89" target="_blank" rel="noopener" class="share-btn-linkedin" aria-label="linkedin-in">
          <i class="fab fa-linkedin-in"></i>
        </a>
      </li>
    
      
      
      
        
      
      
      
      
      
      
      
      <li>
        <a href="whatsapp://send?text=%E6%89%A9%E6%95%A3%E6%A8%A1%E5%9E%8B%EF%BC%88Diffusion&#43;Model%EF%BC%89%20https%3A%2F%2Fikerlz.github.io%2Fpost%2Fddpm%2F" target="_blank" rel="noopener" class="share-btn-whatsapp" aria-label="whatsapp">
          <i class="fab fa-whatsapp"></i>
        </a>
      </li>
    
      
      
      
        
      
      
      
      
      
      
      
      <li>
        <a href="https://service.weibo.com/share/share.php?url=https%3A%2F%2Fikerlz.github.io%2Fpost%2Fddpm%2F&amp;title=%E6%89%A9%E6%95%A3%E6%A8%A1%E5%9E%8B%EF%BC%88Diffusion&#43;Model%EF%BC%89" target="_blank" rel="noopener" class="share-btn-weibo" aria-label="weibo">
          <i class="fab fa-weibo"></i>
        </a>
      </li>
    
  </ul>
</div>











  
  
    




  
















  </div>
</article>
  </div>

  <div class="page-footer">
    
    
    <div class="container">
      <footer class="site-footer">

  












  
  
  
  
  













  
  
  

  
  
    
  
  
    
  

  

  
  <p class="powered-by copyright-license-text">
    © 2024 Me. This work is licensed under <a href="https://creativecommons.org/licenses/by-nc-nd/4.0" rel="noopener noreferrer" target="_blank">CC BY NC ND 4.0</a>
  </p>
  

  <p class="powered-by footer-license-icons">
    <a href="https://creativecommons.org/licenses/by-nc-nd/4.0" rel="noopener noreferrer" target="_blank" aria-label="Creative Commons">
      <i class="fab fa-creative-commons fa-2x" aria-hidden="true"></i>
      <i class="fab fa-creative-commons-by fa-2x" aria-hidden="true"></i>
      
        <i class="fab fa-creative-commons-nc fa-2x" aria-hidden="true"></i>
      
      
        <i class="fab fa-creative-commons-nd fa-2x" aria-hidden="true"></i>
      
    </a>
  </p>





  <p class="powered-by">
    
    
    
      
      
      
      
      
      
      Published with <a href="https://hugoblox.com/?utm_campaign=poweredby" target="_blank" rel="noopener">Hugo Blox Builder</a> — the free, <a href="https://github.com/HugoBlox/hugo-blox-builder" target="_blank" rel="noopener">open source</a> website builder that empowers creators.
    
  </p>
</footer>

    </div>
    
  </div>

  


<script src="/js/vendor-bundle.min.938a3a7554cd9f6602290411f64d2617.js"></script>




  

  
  

  













  
  <script id="search-hit-fuse-template" type="text/x-template">
    <div class="search-hit" id="summary-{{key}}">
      <div class="search-hit-content">
        <div class="search-hit-name">
          <a href="{{relpermalink}}">{{title}}</a>
          <div class="article-metadata search-hit-type">{{type}}</div>
          <p class="search-hit-description">{{snippet}}</p>
        </div>
      </div>
    </div>
  </script>
  
    <script src="https://cdn.jsdelivr.net/gh/krisk/Fuse@v3.2.1/dist/fuse.min.js" integrity="sha512-o38bmzBGX+hD3JHWUFCDA09btWaqrNmoJ3RXLlrysA7PP01Kgs4UlE4MhelE1v5dJR3+cxlR4qQlotsW7jKsnw==" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/gh/julmot/mark.js@8.11.1/dist/jquery.mark.min.js" integrity="sha512-mhbv5DqBMgrWL+32MmsDOt/OAvqr/cHimk6B8y/bx/xS88MVkYGPiVv2ixKVrkywF2qHplNRUvFsAHUdxZ3Krg==" crossorigin="anonymous"></script>
  












  
  
  
  
  
  
  

















<script id="page-data" type="application/json">{"use_headroom":true}</script>


  <script src="/js/wowchemy-headroom.db4755770454eb63685f8de785c0a172.js" type="module"></script>









  
  


<script src="/en/js/wowchemy.min.62586ca65ca61821fe707eb9fa6268b7.js"></script>







  
<div id="modal" class="modal fade" role="dialog">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Cite</h5>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body">
        
        <pre><code></code></pre>
      </div>
      <div class="modal-footer">
        <a class="btn btn-outline-primary my-1 js-copy-cite" href="#" target="_blank">
          <i class="fas fa-copy"></i> Copy
        </a>
        <a class="btn btn-outline-primary my-1 js-download-cite" href="#" target="_blank">
          <i class="fas fa-download"></i> Download
        </a>
        <div id="modal-error"></div>
      </div>
    </div>
  </div>
</div>


  <script src="/js/wowchemy-publication.9137013a66774049159934c29c3f0205.js" type="module"></script>


















</body>
</html>
